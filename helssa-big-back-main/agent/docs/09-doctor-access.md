# ðŸ”‘ Ø¯Ø³ØªØ±Ø³ÛŒ Ù¾Ø²Ø´Ú© Ø¨Ù‡ Ø¨ÛŒÙ…Ø§Ø± HELSSA

## ðŸ“‹ ÙÙ‡Ø±Ø³Øª Ù…Ø·Ø§Ù„Ø¨

- [Ù…Ø¹Ø±ÙÛŒ Ø³ÛŒØ³ØªÙ… Ø¯Ø³ØªØ±Ø³ÛŒ](## ðŸŽ¯ Ù…Ø¹Ø±ÙÛŒ Ø³ÛŒØ³ØªÙ… Ø¯Ø³ØªØ±Ø³ÛŒ)
- [Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÙˆÙ‚Øª](## ðŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÙˆÙ‚Øª)
- [Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ 6 Ø±Ù‚Ù…ÛŒ](## ðŸ”¢ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ 6 Ø±Ù‚Ù…ÛŒ)
- [Ù…Ø¯ÛŒØ±ÛŒØª Ø¬Ù„Ø³Ø§Øª Ø¯Ø³ØªØ±Ø³ÛŒ](## ðŸ”¢ Ù…Ø¯ÛŒØ±ÛŒØª Ø¬Ù„Ø³Ø§Øª Ø¯Ø³ØªØ±Ø³ÛŒ)
- [Ø³Ø·ÙˆØ­ Ø¯Ø³ØªØ±Ø³ÛŒ](## ðŸ”¢ Ø³Ø·ÙˆØ­ Ø¯Ø³ØªØ±Ø³ÛŒ)
- [Audit Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ](## ðŸ”¢ Audit Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ)
- [Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ](## ðŸ”¢ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ)
- [Ø§Ù…Ù†ÛŒØª Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§](## ðŸ”¢ Ø§Ù…Ù†ÛŒØª Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§)

---

## ðŸŽ¯ Ù…Ø¹Ø±ÙÛŒ Ø³ÛŒØ³ØªÙ… Ø¯Ø³ØªØ±Ø³ÛŒ

Ø³ÛŒØ³ØªÙ… Ø¯Ø³ØªØ±Ø³ÛŒ Ù¾Ø²Ø´Ú© Ø¨Ù‡ Ø¨ÛŒÙ…Ø§Ø± Ø¯Ø± HELSSA ÛŒÚ© Ù…Ú©Ø§Ù†ÛŒØ²Ù… Ø§Ù…Ù† Ùˆ Ù…ÙˆÙ‚Øª Ø¨Ø±Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø²Ø´Ú©ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¨Ù‡ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ú©Ù†ØªØ±Ù„ Ú©Ø§Ù…Ù„ Ø¨Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.

### ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ

- ðŸ”¢ **Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ 6 Ø±Ù‚Ù…ÛŒ** Ø³Ø§Ø¯Ù‡ Ùˆ Ø§Ù…Ù†
- â±ï¸ **Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÙˆÙ‚Øª** Ø¨Ø§ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§
- ðŸŽšï¸ **Ø³Ø·ÙˆØ­ Ø¯Ø³ØªØ±Ø³ÛŒ** Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ…
- ðŸ“ **Audit Trail** Ú©Ø§Ù…Ù„
- ðŸ” **Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ End-to-End**
- ðŸ“± **Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø³Ø§Ø¯Ù‡** Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø± Ùˆ Ù¾Ø²Ø´Ú©
- ðŸš« **Ù‚Ø§Ø¨Ù„ÛŒØª Ù„ØºÙˆ ÙÙˆØ±ÛŒ** ØªÙˆØ³Ø· Ø¨ÛŒÙ…Ø§Ø±

## ðŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÙˆÙ‚Øª

```mermaid
graph TB
    subgraph "Patient Side"
        PAT[Ø¨ÛŒÙ…Ø§Ø±]
        PAPP[Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¨ÛŒÙ…Ø§Ø±]
    end
    
    subgraph "Access Control System"
        ACG[Access Code Generator]
        ACV[Access Code Validator]
        ASM[Access Session Manager]
        APM[Access Permission Manager]
    end
    
    subgraph "Doctor Side"
        DOC[Ù¾Ø²Ø´Ú©]
        DAPP[Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù¾Ø²Ø´Ú©]
    end
    
    subgraph "Data Layer"
        REDIS[(Redis Cache)]
        DB[(Access DB)]
        AUDIT[(Audit Logs)]
    end
    
    PAT --> PAPP
    PAPP --> ACG
    ACG --> REDIS
    ACG --> DB
    
    DOC --> DAPP
    DAPP --> ACV
    ACV --> REDIS
    ACV --> ASM
    ASM --> APM
    
    APM --> DB
    All --> AUDIT
```

### Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø±ÙˆÚ˜Ù‡

```python
unified_access/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ access_code.py          # Ù…Ø¯Ù„ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ
â”‚   â”œâ”€â”€ access_session.py       # Ù…Ø¯Ù„ Ø¬Ù„Ø³Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ
â”‚   â”œâ”€â”€ access_permission.py    # Ù…Ø¯Ù„ Ù…Ø¬ÙˆØ²Ù‡Ø§
â”‚   â””â”€â”€ access_log.py           # Ù…Ø¯Ù„ Ù„Ø§Ú¯ Ø¯Ø³ØªØ±Ø³ÛŒ
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ code_generator.py       # ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯
â”‚   â”œâ”€â”€ code_validator.py       # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯
â”‚   â”œâ”€â”€ session_manager.py      # Ù…Ø¯ÛŒØ±ÛŒØª Ø¬Ù„Ø³Ø§Øª
â”‚   â”œâ”€â”€ permission_checker.py   # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ²Ù‡Ø§
â”‚   â””â”€â”€ audit_service.py        # Ø«Ø¨Øª audit
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ serializers.py
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”œâ”€â”€ patient_views.py    # API Ø¨ÛŒÙ…Ø§Ø±
â”‚   â”‚   â””â”€â”€ doctor_views.py     # API Ù¾Ø²Ø´Ú©
â”‚   â””â”€â”€ permissions.py
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ code_utils.py           # Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ø¯
â”‚   â”œâ”€â”€ security.py             # Ø§Ù…Ù†ÛŒØª
â”‚   â””â”€â”€ notifications.py        # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ
â””â”€â”€ tasks.py                     # Celery tasks
```

## ðŸ”¢ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ 6 Ø±Ù‚Ù…ÛŒ

### Access Code Model

```python
# unified_access/models/access_code.py
from django.db import models
import uuid
from datetime import timedelta

class AccessCode(models.Model):
    """Ù…Ø¯Ù„ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÙˆÙ‚Øª"""
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4)
    
    # Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ
    code = models.CharField(
        max_length=6,
        unique=True,
        db_index=True,
        help_text="Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ 6 Ø±Ù‚Ù…ÛŒ"
    )
    
    # Ù…Ø§Ù„Ú© Ùˆ Ù…Ù‚ØµØ¯
    patient = models.ForeignKey(
        'unified_auth.UnifiedUser',
        on_delete=models.CASCADE,
        related_name='generated_access_codes'
    )
    doctor = models.ForeignKey(
        'unified_auth.UnifiedUser',
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='received_access_codes',
        help_text="Ù¾Ø²Ø´Ú© Ù…Ø´Ø®Øµ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"
    )
    
    # Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§
    permissions = models.JSONField(
        default=list,
        help_text="Ù„ÛŒØ³Øª Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡"
    )
    """
    [
        "view_basic_info",
        "view_medical_history",
        "view_lab_results",
        "view_prescriptions",
        "view_encounters",
        "add_notes",
        "prescribe_medication"
    ]
    """
    
    # Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ
    created_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField()
    duration_hours = models.IntegerField(
        default=24,
        help_text="Ù…Ø¯Øª Ø§Ø¹ØªØ¨Ø§Ø± Ø¨Ù‡ Ø³Ø§Ø¹Øª"
    )
    
    # ÙˆØ¶Ø¹ÛŒØª
    is_active = models.BooleanField(default=True)
    is_used = models.BooleanField(default=False)
    used_at = models.DateTimeField(null=True, blank=True)
    used_by = models.ForeignKey(
        'unified_auth.UnifiedUser',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='used_access_codes'
    )
    
    # Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ø³ØªÙØ§Ø¯Ù‡
    max_uses = models.IntegerField(
        default=1,
        help_text="Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡"
    )
    use_count = models.IntegerField(default=0)
    
    # metadata
    purpose = models.CharField(
        max_length=100,
        null=True,
        blank=True,
        help_text="Ù‡Ø¯Ù Ø§Ø² Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø¯"
    )
    metadata = models.JSONField(default=dict)
    
    class Meta:
        db_table = 'access_codes'
        indexes = [
            models.Index(fields=['code', 'is_active']),
            models.Index(fields=['patient', 'is_active']),
            models.Index(fields=['expires_at']),
        ]
        
    def is_valid(self) -> bool:
        """Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ú©Ø¯"""
        now = timezone.now()
        return (
            self.is_active and
            not self.is_used and
            self.expires_at > now and
            self.use_count < self.max_uses
        )
```

### Code Generator Service

```python
# unified_access/services/code_generator.py
import secrets
import string
from typing import List, Optional, Dict
from datetime import datetime, timedelta

class AccessCodeGenerator:
    """Ø³Ø±ÙˆÛŒØ³ ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ"""
    
    def __init__(self):
        self.redis_client = get_redis_client()
        self.notification_service = NotificationService()
        
    async def generate_access_code(
        self,
        patient_id: str,
        permissions: List[str],
        duration_hours: int = 24,
        doctor_id: Optional[str] = None,
        purpose: Optional[str] = None
    ) -> AccessCode:
        """ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¬Ø¯ÛŒØ¯"""
        
        # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
        patient = await UnifiedUser.objects.get(id=patient_id)
        if patient.user_type != 'patient':
            raise ValueError("ÙÙ‚Ø· Ø¨ÛŒÙ…Ø§Ø±Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ù†Ø¯")
            
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ú©Ø¯Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„
        active_codes = await AccessCode.objects.filter(
            patient=patient,
            is_active=True,
            expires_at__gt=timezone.now()
        ).count()
        
        if active_codes >= 5:
            raise LimitExceeded("Ø­Ø¯Ø§Ú©Ø«Ø± 5 Ú©Ø¯ ÙØ¹Ø§Ù„ Ù…Ø¬Ø§Ø² Ø§Ø³Øª")
            
        # ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ ÛŒÚ©ØªØ§
        code = await self._generate_unique_code()
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§
        expires_at = timezone.now() + timedelta(hours=duration_hours)
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯
        access_code = await AccessCode.objects.create(
            code=code,
            patient=patient,
            doctor_id=doctor_id,
            permissions=permissions,
            duration_hours=duration_hours,
            expires_at=expires_at,
            purpose=purpose,
            metadata={
                'created_ip': self._get_client_ip(),
                'created_device': self._get_device_info()
            }
        )
        
        # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ú©Ø´ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹
        await self._cache_access_code(access_code)
        
        # Ø§Ø±Ø³Ø§Ù„ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
        await self._send_code_notification(patient, code, expires_at)
        
        # Audit log
        await self._log_code_generation(access_code)
        
        return access_code
        
    async def _generate_unique_code(self) -> str:
        """ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ 6 Ø±Ù‚Ù…ÛŒ ÛŒÚ©ØªØ§"""
        
        max_attempts = 10
        for _ in range(max_attempts):
            # ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ ØªØµØ§Ø¯ÙÛŒ
            code = ''.join(secrets.choice(string.digits) for _ in range(6))
            
            # Ø¨Ø±Ø±Ø³ÛŒ ÛŒÚ©ØªØ§ Ø¨ÙˆØ¯Ù†
            exists = await AccessCode.objects.filter(
                code=code,
                is_active=True
            ).exists()
            
            if not exists:
                return code
                
        raise RuntimeError("Ø§Ù…Ú©Ø§Ù† ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ ÛŒÚ©ØªØ§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯")
        
    async def _cache_access_code(self, access_code: AccessCode):
        """Ø°Ø®ÛŒØ±Ù‡ Ú©Ø¯ Ø¯Ø± Ú©Ø´"""
        
        cache_key = f"access_code:{access_code.code}"
        cache_data = {
            'id': str(access_code.id),
            'patient_id': str(access_code.patient_id),
            'doctor_id': str(access_code.doctor_id) if access_code.doctor_id else None,
            'permissions': access_code.permissions,
            'expires_at': access_code.expires_at.isoformat(),
            'use_count': access_code.use_count,
            'max_uses': access_code.max_uses
        }
        
        ttl = int((access_code.expires_at - timezone.now()).total_seconds())
        await self.redis_client.setex(
            cache_key,
            ttl,
            json.dumps(cache_data)
        )
        
    async def revoke_access_code(
        self,
        code_id: str,
        revoked_by: str,
        reason: Optional[str] = None
    ) -> bool:
        """Ù„ØºÙˆ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ"""
        
        access_code = await AccessCode.objects.get(id=code_id)
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ² Ù„ØºÙˆ
        if str(access_code.patient_id) != revoked_by:
            raise PermissionDenied("ÙÙ‚Ø· ØµØ§Ø­Ø¨ Ú©Ø¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¢Ù† Ø±Ø§ Ù„ØºÙˆ Ú©Ù†Ø¯")
            
        # Ù„ØºÙˆ Ú©Ø¯
        access_code.is_active = False
        access_code.metadata['revoked_at'] = timezone.now().isoformat()
        access_code.metadata['revoked_by'] = revoked_by
        access_code.metadata['revoke_reason'] = reason
        await access_code.save()
        
        # Ø­Ø°Ù Ø§Ø² Ú©Ø´
        await self.redis_client.delete(f"access_code:{access_code.code}")
        
        # Ù„ØºÙˆ Ø¬Ù„Ø³Ø§Øª Ù…Ø±ØªØ¨Ø·
        await self._revoke_related_sessions(access_code)
        
        # Audit log
        await self._log_code_revocation(access_code, reason)
        
        return True
```

### Code Validator Service

```python
# unified_access/services/code_validator.py

class AccessCodeValidator:
    """Ø³Ø±ÙˆÛŒØ³ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ"""
    
    def __init__(self):
        self.redis_client = get_redis_client()
        self.session_manager = AccessSessionManager()
        self.audit_service = AuditService()
        
    async def validate_access_code(
        self,
        code: str,
        doctor_id: str,
        device_info: Dict
    ) -> Dict:
        """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ø¯"""
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø± Ú©Ø´
        cache_key = f"access_code:{code}"
        cached_data = await self.redis_client.get(cache_key)
        
        if cached_data:
            code_data = json.loads(cached_data)
            access_code_id = code_data['id']
        else:
            # Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            try:
                access_code = await AccessCode.objects.get(
                    code=code,
                    is_active=True
                )
                access_code_id = str(access_code.id)
            except AccessCode.DoesNotExist:
                # Ø«Ø¨Øª ØªÙ„Ø§Ø´ Ù†Ø§Ù…ÙˆÙÙ‚
                await self._log_failed_attempt(code, doctor_id)
                raise InvalidAccessCode("Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª")
                
        # Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ú©Ø§Ù…Ù„ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        access_code = await AccessCode.objects.select_for_update().get(
            id=access_code_id
        )
        
        # Ø¨Ø±Ø±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±
        validation_errors = await self._validate_code_constraints(
            access_code, doctor_id
        )
        
        if validation_errors:
            await self._log_validation_failure(
                access_code, doctor_id, validation_errors
            )
            raise InvalidAccessCode(validation_errors[0])
            
        # Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ù„Ø³Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ
        session = await self.session_manager.create_session(
            access_code=access_code,
            doctor_id=doctor_id,
            device_info=device_info
        )
        
        # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡
        access_code.use_count += 1
        if access_code.use_count >= access_code.max_uses:
            access_code.is_used = True
            access_code.used_at = timezone.now()
            access_code.used_by_id = doctor_id
            
        await access_code.save()
        
        # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø´
        await self._update_cache(access_code)
        
        # Ø§Ø±Ø³Ø§Ù„ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ù‡ Ø¨ÛŒÙ…Ø§Ø±
        await self._notify_access_granted(access_code, doctor_id)
        
        # Audit log
        await self.audit_service.log_access_granted(
            access_code, doctor_id, session
        )
        
        return {
            'session_id': str(session.id),
            'patient_id': str(access_code.patient_id),
            'permissions': access_code.permissions,
            'expires_at': session.expires_at.isoformat(),
            'patient_name': access_code.patient.get_full_name()
        }
        
    async def _validate_code_constraints(
        self,
        access_code: AccessCode,
        doctor_id: str
    ) -> List[str]:
        """Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ú©Ø¯"""
        
        errors = []
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§
        if timezone.now() > access_code.expires_at:
            errors.append("Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª")
            
        # Ø¨Ø±Ø±Ø³ÛŒ ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù†
        if not access_code.is_active:
            errors.append("Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª")
            
        # Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡
        if access_code.use_count >= access_code.max_uses:
            errors.append("Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª")
            
        # Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø²Ø´Ú© Ù…Ø´Ø®Øµ
        if access_code.doctor_id and str(access_code.doctor_id) != doctor_id:
            errors.append("Ø§ÛŒÙ† Ú©Ø¯ Ø¨Ø±Ø§ÛŒ Ù¾Ø²Ø´Ú© Ø¯ÛŒÚ¯Ø±ÛŒ ØµØ§Ø¯Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª")
            
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù†ÛŒ (Ù…Ø«Ù„Ø§Ù‹ Ø¯Ø± Ø³Ø§Ø¹Ø§Øª Ø§Ø¯Ø§Ø±ÛŒ)
        if access_code.metadata.get('office_hours_only'):
            if not self._is_office_hours():
                errors.append("Ú©Ø¯ ÙÙ‚Ø· Ø¯Ø± Ø³Ø§Ø¹Ø§Øª Ø§Ø¯Ø§Ø±ÛŒ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª")
                
        return errors
        
    async def _log_failed_attempt(self, code: str, doctor_id: str):
        """Ø«Ø¨Øª ØªÙ„Ø§Ø´ Ù†Ø§Ù…ÙˆÙÙ‚"""
        
        # Ø«Ø¨Øª Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        await AccessAttempt.objects.create(
            attempted_code=code[:3] + '***',  # ÙÙ‚Ø· 3 Ø±Ù‚Ù… Ø§ÙˆÙ„
            doctor_id=doctor_id,
            success=False,
            ip_address=self._get_client_ip(),
            user_agent=self._get_user_agent()
        )
        
        # Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚
        recent_attempts = await AccessAttempt.objects.filter(
            doctor_id=doctor_id,
            success=False,
            created_at__gte=timezone.now() - timedelta(minutes=10)
        ).count()
        
        if recent_attempts >= 5:
            # Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ù…ÙˆÙ‚Øª
            await self._block_doctor_temporarily(doctor_id)
```

## ðŸ” Ù…Ø¯ÛŒØ±ÛŒØª Ø¬Ù„Ø³Ø§Øª Ø¯Ø³ØªØ±Ø³ÛŒ

### Access Session Model

```python
# unified_access/models/access_session.py

class AccessSession(models.Model):
    """Ù…Ø¯Ù„ Ø¬Ù„Ø³Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù¾Ø²Ø´Ú© Ø¨Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±"""
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4)
    
    # Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª
    access_code = models.ForeignKey(
        AccessCode,
        on_delete=models.CASCADE,
        related_name='sessions'
    )
    doctor = models.ForeignKey(
        'unified_auth.UnifiedUser',
        on_delete=models.CASCADE,
        related_name='access_sessions'
    )
    patient = models.ForeignKey(
        'unified_auth.UnifiedUser',
        on_delete=models.CASCADE,
        related_name='granted_sessions'
    )
    
    # ØªÙˆÚ©Ù† Ø¬Ù„Ø³Ù‡
    session_token = models.CharField(
        max_length=255,
        unique=True,
        db_index=True
    )
    
    # Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ
    created_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField()
    last_activity = models.DateTimeField(auto_now=True)
    
    # ÙˆØ¶Ø¹ÛŒØª
    is_active = models.BooleanField(default=True)
    terminated_at = models.DateTimeField(null=True, blank=True)
    termination_reason = models.CharField(
        max_length=50,
        null=True,
        blank=True,
        choices=[
            ('expired', 'Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡'),
            ('revoked', 'Ù„ØºÙˆ Ø´Ø¯Ù‡'),
            ('logout', 'Ø®Ø±ÙˆØ¬'),
            ('timeout', 'Ø¹Ø¯Ù… ÙØ¹Ø§Ù„ÛŒØª'),
        ]
    )
    
    # Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ø¬Ù„Ø³Ù‡
    permissions = models.JSONField(
        help_text="Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ø§ÛŒÙ† Ø¬Ù„Ø³Ù‡"
    )
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø³ØªÚ¯Ø§Ù‡
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField()
    device_id = models.CharField(max_length=100, null=True, blank=True)
    
    # Ø¢Ù…Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡
    access_count = models.IntegerField(
        default=0,
        help_text="ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± Ø§ÛŒÙ† Ø¬Ù„Ø³Ù‡"
    )
    last_accessed_resource = models.CharField(
        max_length=100,
        null=True,
        blank=True
    )
    
    class Meta:
        db_table = 'access_sessions'
        indexes = [
            models.Index(fields=['session_token']),
            models.Index(fields=['doctor', 'is_active']),
            models.Index(fields=['patient', 'is_active']),
            models.Index(fields=['expires_at']),
        ]
```

### Session Manager Service

```python
# unified_access/services/session_manager.py
import jwt
from typing import Dict, Optional, List

class AccessSessionManager:
    """Ù…Ø¯ÛŒØ±ÛŒØª Ø¬Ù„Ø³Ø§Øª Ø¯Ø³ØªØ±Ø³ÛŒ"""
    
    def __init__(self):
        self.redis_client = get_redis_client()
        self.notification_service = NotificationService()
        
    async def create_session(
        self,
        access_code: AccessCode,
        doctor_id: str,
        device_info: Dict
    ) -> AccessSession:
        """Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ù„Ø³Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¬Ø¯ÛŒØ¯"""
        
        # ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù† Ø¬Ù„Ø³Ù‡
        session_token = self._generate_session_token(
            access_code, doctor_id
        )
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§
        expires_at = min(
            access_code.expires_at,
            timezone.now() + timedelta(hours=8)  # Ø­Ø¯Ø§Ú©Ø«Ø± 8 Ø³Ø§Ø¹Øª
        )
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ù„Ø³Ù‡
        session = await AccessSession.objects.create(
            access_code=access_code,
            doctor_id=doctor_id,
            patient=access_code.patient,
            session_token=session_token,
            expires_at=expires_at,
            permissions=access_code.permissions,
            ip_address=device_info['ip_address'],
            user_agent=device_info['user_agent'],
            device_id=device_info.get('device_id')
        )
        
        # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ú©Ø´
        await self._cache_session(session)
        
        # Ø§Ø±Ø³Ø§Ù„ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ù‡ Ø¨ÛŒÙ…Ø§Ø±
        await self.notification_service.notify_session_created(
            session.patient,
            session.doctor,
            session
        )
        
        return session
        
    async def validate_session(
        self,
        session_token: str,
        requested_permission: Optional[str] = None
    ) -> Dict:
        """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¬Ù„Ø³Ù‡"""
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø± Ú©Ø´
        cached_session = await self._get_cached_session(session_token)
        
        if cached_session:
            session_data = cached_session
        else:
            # Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³
            try:
                session = await AccessSession.objects.select_related(
                    'doctor', 'patient'
                ).get(
                    session_token=session_token,
                    is_active=True
                )
                session_data = self._serialize_session(session)
                
                # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ú©Ø´
                await self._cache_session_data(session_token, session_data)
                
            except AccessSession.DoesNotExist:
                raise InvalidSession("Ø¬Ù„Ø³Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª")
                
        # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§
        if datetime.fromisoformat(session_data['expires_at']) < timezone.now():
            await self.terminate_session(
                session_token, 'expired'
            )
            raise SessionExpired("Ø¬Ù„Ø³Ù‡ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª")
            
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ² Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ
        if requested_permission:
            if requested_permission not in session_data['permissions']:
                raise PermissionDenied(
                    f"Ù…Ø¬ÙˆØ² {requested_permission} Ø¯Ø± Ø§ÛŒÙ† Ø¬Ù„Ø³Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
                )
                
        # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙØ¹Ø§Ù„ÛŒØª
        await self._update_session_activity(session_data['id'])
        
        return session_data
        
    async def terminate_session(
        self,
        session_token: str,
        reason: str = 'logout'
    ) -> bool:
        """Ø®Ø§ØªÙ…Ù‡ Ø¬Ù„Ø³Ù‡"""
        
        session = await AccessSession.objects.get(
            session_token=session_token
        )
        
        # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª
        session.is_active = False
        session.terminated_at = timezone.now()
        session.termination_reason = reason
        await session.save()
        
        # Ø­Ø°Ù Ø§Ø² Ú©Ø´
        await self.redis_client.delete(f"session:{session_token}")
        
        # Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
        if reason == 'revoked':
            await self.notification_service.notify_session_revoked(
                session.patient,
                session.doctor,
                session
            )
            
        return True
        
    async def get_active_sessions(
        self,
        patient_id: str
    ) -> List[Dict]:
        """Ø¯Ø±ÛŒØ§ÙØª Ø¬Ù„Ø³Ø§Øª ÙØ¹Ø§Ù„ Ø¨ÛŒÙ…Ø§Ø±"""
        
        sessions = await AccessSession.objects.filter(
            patient_id=patient_id,
            is_active=True,
            expires_at__gt=timezone.now()
        ).select_related('doctor').order_by('-created_at')
        
        return [
            {
                'id': str(session.id),
                'doctor': {
                    'id': str(session.doctor.id),
                    'name': session.doctor.get_full_name(),
                    'specialty': session.doctor.doctor_profile.specialty
                },
                'permissions': session.permissions,
                'created_at': session.created_at.isoformat(),
                'expires_at': session.expires_at.isoformat(),
                'last_activity': session.last_activity.isoformat(),
                'access_count': session.access_count,
                'can_revoke': True
            }
            for session in sessions
        ]
        
    def _generate_session_token(
        self,
        access_code: AccessCode,
        doctor_id: str
    ) -> str:
        """ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù† Ø¬Ù„Ø³Ù‡"""
        
        payload = {
            'access_code_id': str(access_code.id),
            'doctor_id': doctor_id,
            'patient_id': str(access_code.patient_id),
            'permissions': access_code.permissions,
            'iat': datetime.utcnow(),
            'jti': str(uuid.uuid4())  # Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§
        }
        
        return jwt.encode(
            payload,
            settings.SECRET_KEY,
            algorithm='HS256'
        )
```

## ðŸŽšï¸ Ø³Ø·ÙˆØ­ Ø¯Ø³ØªØ±Ø³ÛŒ

### Permission Types

```python
# unified_access/models/permissions.py

class AccessPermission:
    """ØªØ¹Ø±ÛŒÙ Ø§Ù†ÙˆØ§Ø¹ Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ"""
    
    # Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡
    VIEW_BASIC_INFO = 'view_basic_info'           # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡
    VIEW_MEDICAL_HISTORY = 'view_medical_history' # Ø³Ø§Ø¨Ù‚Ù‡ Ù¾Ø²Ø´Ú©ÛŒ
    VIEW_LAB_RESULTS = 'view_lab_results'         # Ù†ØªØ§ÛŒØ¬ Ø¢Ø²Ù…Ø§ÛŒØ´
    VIEW_IMAGING = 'view_imaging'                 # ØªØµØ§ÙˆÛŒØ± Ù¾Ø²Ø´Ú©ÛŒ
    VIEW_PRESCRIPTIONS = 'view_prescriptions'     # Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§
    VIEW_ENCOUNTERS = 'view_encounters'           # Ù…Ù„Ø§Ù‚Ø§Øªâ€ŒÙ‡Ø§
    VIEW_VITALS = 'view_vitals'                   # Ø¹Ù„Ø§Ø¦Ù… Ø­ÛŒØ§ØªÛŒ
    VIEW_ALLERGIES = 'view_allergies'             # Ø¢Ù„Ø±Ú˜ÛŒâ€ŒÙ‡Ø§
    
    # Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´
    ADD_NOTES = 'add_notes'                       # Ø§ÙØ²ÙˆØ¯Ù† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª
    PRESCRIBE_MEDICATION = 'prescribe_medication' # ØªØ¬ÙˆÛŒØ² Ø¯Ø§Ø±Ùˆ
    ORDER_LAB_TESTS = 'order_lab_tests'          # Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¢Ø²Ù…Ø§ÛŒØ´
    UPDATE_DIAGNOSIS = 'update_diagnosis'         # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ´Ø®ÛŒØµ
    
    # Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡
    DOWNLOAD_FILES = 'download_files'             # Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
    SHARE_WITH_OTHERS = 'share_with_others'       # Ø§Ø´ØªØ±Ø§Ú© Ø¨Ø§ Ø¯ÛŒÚ¯Ø±Ø§Ù†
    FULL_ACCESS = 'full_access'                   # Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„
    
    # Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø¬ÙˆØ²Ù‡Ø§
    PERMISSION_GROUPS = {
        'basic': [VIEW_BASIC_INFO, VIEW_VITALS, VIEW_ALLERGIES],
        'medical_history': [VIEW_MEDICAL_HISTORY, VIEW_ENCOUNTERS],
        'diagnostic': [VIEW_LAB_RESULTS, VIEW_IMAGING],
        'treatment': [VIEW_PRESCRIPTIONS, ADD_NOTES],
        'full_read': [
            VIEW_BASIC_INFO, VIEW_MEDICAL_HISTORY, VIEW_LAB_RESULTS,
            VIEW_IMAGING, VIEW_PRESCRIPTIONS, VIEW_ENCOUNTERS,
            VIEW_VITALS, VIEW_ALLERGIES
        ],
        'full_write': [
            ADD_NOTES, PRESCRIBE_MEDICATION, ORDER_LAB_TESTS,
            UPDATE_DIAGNOSIS
        ]
    }
```

### Permission Checker Service

```python
# unified_access/services/permission_checker.py

class PermissionChecker:
    """Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ"""
    
    def __init__(self):
        self.cache = get_redis_client()
        self.audit_service = AuditService()
        
    async def check_permission(
        self,
        session_token: str,
        resource_type: str,
        resource_id: str,
        action: str
    ) -> bool:
        """Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ² Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…Ù†Ø¨Ø¹"""
        
        # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¬Ù„Ø³Ù‡
        session_manager = AccessSessionManager()
        session_data = await session_manager.validate_session(
            session_token
        )
        
        # ØªØ¨Ø¯ÛŒÙ„ action Ø¨Ù‡ permission
        required_permission = self._map_action_to_permission(
            resource_type, action
        )
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ²
        has_permission = (
            required_permission in session_data['permissions'] or
            AccessPermission.FULL_ACCESS in session_data['permissions']
        )
        
        # Ø«Ø¨Øª audit log
        await self.audit_service.log_access_attempt(
            session_id=session_data['id'],
            resource_type=resource_type,
            resource_id=resource_id,
            action=action,
            granted=has_permission
        )
        
        if not has_permission:
            raise PermissionDenied(
                f"Ø´Ù…Ø§ Ù…Ø¬ÙˆØ² {action} Ø¨Ø±Ø§ÛŒ {resource_type} Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯"
            )
            
        return True
        
    async def get_accessible_resources(
        self,
        session_token: str,
        resource_type: str
    ) -> List[str]:
        """Ø¯Ø±ÛŒØ§ÙØª Ù…Ù†Ø§Ø¨Ø¹ Ù‚Ø§Ø¨Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ"""
        
        session_data = await AccessSessionManager().validate_session(
            session_token
        )
        
        patient_id = session_data['patient_id']
        permissions = session_data['permissions']
        
        accessible_ids = []
        
        if resource_type == 'encounter':
            if AccessPermission.VIEW_ENCOUNTERS in permissions:
                encounters = await Encounter.objects.filter(
                    patient_id=patient_id
                ).values_list('id', flat=True)
                accessible_ids = [str(id) for id in encounters]
                
        elif resource_type == 'lab_result':
            if AccessPermission.VIEW_LAB_RESULTS in permissions:
                lab_results = await LabResult.objects.filter(
                    patient_id=patient_id
                ).values_list('id', flat=True)
                accessible_ids = [str(id) for id in lab_results]
                
        # Ùˆ ØºÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ø³Ø§ÛŒØ± Ù…Ù†Ø§Ø¨Ø¹...
        
        return accessible_ids
        
    def _map_action_to_permission(
        self,
        resource_type: str,
        action: str
    ) -> str:
        """ØªØ¨Ø¯ÛŒÙ„ action Ø¨Ù‡ permission"""
        
        mapping = {
            'encounter': {
                'view': AccessPermission.VIEW_ENCOUNTERS,
                'download': AccessPermission.DOWNLOAD_FILES,
            },
            'lab_result': {
                'view': AccessPermission.VIEW_LAB_RESULTS,
                'download': AccessPermission.DOWNLOAD_FILES,
            },
            'prescription': {
                'view': AccessPermission.VIEW_PRESCRIPTIONS,
                'create': AccessPermission.PRESCRIBE_MEDICATION,
            },
            'medical_history': {
                'view': AccessPermission.VIEW_MEDICAL_HISTORY,
                'update': AccessPermission.ADD_NOTES,
            }
        }
        
        return mapping.get(resource_type, {}).get(
            action,
            AccessPermission.FULL_ACCESS
        )
```

## ðŸ“ Audit Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ

### Access Log Model

```python
# unified_access/models/access_log.py

class AccessLog(models.Model):
    """Ù„Ø§Ú¯ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§"""
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4)
    
    # Ø¬Ù„Ø³Ù‡ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
    session = models.ForeignKey(
        AccessSession,
        on_delete=models.CASCADE,
        related_name='access_logs'
    )
    doctor = models.ForeignKey(
        'unified_auth.UnifiedUser',
        on_delete=models.CASCADE,
        related_name='doctor_access_logs'
    )
    patient = models.ForeignKey(
        'unified_auth.UnifiedUser',
        on_delete=models.CASCADE,
        related_name='patient_access_logs'
    )
    
    # Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø³ØªØ±Ø³ÛŒ
    resource_type = models.CharField(
        max_length=50,
        choices=[
            ('patient_info', 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±'),
            ('encounter', 'Ù…Ù„Ø§Ù‚Ø§Øª'),
            ('lab_result', 'Ù†ØªÛŒØ¬Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´'),
            ('prescription', 'Ù†Ø³Ø®Ù‡'),
            ('medical_image', 'ØªØµÙˆÛŒØ± Ù¾Ø²Ø´Ú©ÛŒ'),
            ('report', 'Ú¯Ø²Ø§Ø±Ø´'),
        ]
    )
    resource_id = models.CharField(max_length=100)
    action = models.CharField(
        max_length=20,
        choices=[
            ('view', 'Ù…Ø´Ø§Ù‡Ø¯Ù‡'),
            ('download', 'Ø¯Ø§Ù†Ù„ÙˆØ¯'),
            ('create', 'Ø§ÛŒØ¬Ø§Ø¯'),
            ('update', 'Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ'),
            ('delete', 'Ø­Ø°Ù'),
        ]
    )
    
    # Ù†ØªÛŒØ¬Ù‡
    granted = models.BooleanField(
        help_text="Ø¢ÛŒØ§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯"
    )
    denial_reason = models.CharField(
        max_length=100,
        null=True,
        blank=True
    )
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙÙ†ÛŒ
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField()
    
    # Ø²Ù…Ø§Ù†
    accessed_at = models.DateTimeField(auto_now_add=True)
    
    # Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ (Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ§Ø±Ø¯ÛŒ Ú©Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø§Ø³Øª)
    accessed_fields = models.JSONField(
        null=True,
        blank=True,
        help_text="ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø´Ø¯Ù†Ø¯"
    )
    
    class Meta:
        db_table = 'access_logs'
        indexes = [
            models.Index(fields=['session', 'accessed_at']),
            models.Index(fields=['patient', 'accessed_at']),
            models.Index(fields=['doctor', 'accessed_at']),
            models.Index(fields=['resource_type', 'resource_id']),
        ]
        ordering = ['-accessed_at']
```

### Audit Service

```python
# unified_access/services/audit_service.py

class AccessAuditService:
    """Ø³Ø±ÙˆÛŒØ³ Ø«Ø¨Øª Ùˆ Ú¯Ø²Ø§Ø±Ø´ audit"""
    
    def __init__(self):
        self.notification_service = NotificationService()
        
    async def log_access_attempt(
        self,
        session_id: str,
        resource_type: str,
        resource_id: str,
        action: str,
        granted: bool,
        denial_reason: Optional[str] = None,
        accessed_fields: Optional[List[str]] = None
    ) -> AccessLog:
        """Ø«Ø¨Øª ÛŒÚ© ØªÙ„Ø§Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ"""
        
        session = await AccessSession.objects.select_related(
            'doctor', 'patient'
        ).get(id=session_id)
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ù„Ø§Ú¯
        log = await AccessLog.objects.create(
            session=session,
            doctor=session.doctor,
            patient=session.patient,
            resource_type=resource_type,
            resource_id=resource_id,
            action=action,
            granted=granted,
            denial_reason=denial_reason,
            ip_address=session.ip_address,
            user_agent=session.user_agent,
            accessed_fields=accessed_fields
        )
        
        # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø± Ø¬Ù„Ø³Ù‡
        if granted:
            session.access_count += 1
            session.last_accessed_resource = f"{resource_type}:{resource_id}"
            await session.save()
            
        # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³
        if resource_type in ['medical_image', 'prescription'] and granted:
            await self.notification_service.notify_sensitive_access(
                session.patient,
                session.doctor,
                resource_type,
                action
            )
            
        return log
        
    async def get_access_report(
        self,
        patient_id: str,
        start_date: Optional[datetime] = None,
        end_date: Optional[datetime] = None,
        doctor_id: Optional[str] = None
    ) -> Dict:
        """Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§"""
        
        # Query builder
        query = AccessLog.objects.filter(patient_id=patient_id)
        
        if start_date:
            query = query.filter(accessed_at__gte=start_date)
        if end_date:
            query = query.filter(accessed_at__lte=end_date)
        if doctor_id:
            query = query.filter(doctor_id=doctor_id)
            
        # Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ
        summary = await query.aggregate(
            total_accesses=Count('id'),
            unique_doctors=Count('doctor', distinct=True),
            unique_resources=Count('resource_id', distinct=True),
            granted_count=Count('id', filter=Q(granted=True)),
            denied_count=Count('id', filter=Q(granted=False))
        )
        
        # Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ù…Ù†Ø¨Ø¹
        by_resource_type = await query.values('resource_type').annotate(
            count=Count('id'),
            granted=Count('id', filter=Q(granted=True))
        ).order_by('-count')
        
        # Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø²Ø´Ú©
        by_doctor = await query.values(
            'doctor__first_name',
            'doctor__last_name',
            'doctor__doctor_profile__specialty'
        ).annotate(
            count=Count('id'),
            last_access=Max('accessed_at')
        ).order_by('-count')
        
        # Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±
        recent_accesses = await query.select_related(
            'doctor', 'session'
        ).order_by('-accessed_at')[:20]
        
        return {
            'summary': summary,
            'by_resource_type': list(by_resource_type),
            'by_doctor': list(by_doctor),
            'recent_accesses': [
                self._serialize_access_log(log)
                for log in recent_accesses
            ],
            'report_period': {
                'start': start_date.isoformat() if start_date else None,
                'end': end_date.isoformat() if end_date else None
            }
        }
        
    async def get_suspicious_activities(
        self,
        patient_id: str
    ) -> List[Dict]:
        """Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø´Ú©ÙˆÚ©"""
        
        suspicious = []
        
        # Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ Ø§Ø² Ø³Ø§Ø¹Øª Ø§Ø¯Ø§Ø±ÛŒ
        after_hours = await AccessLog.objects.filter(
            patient_id=patient_id,
            accessed_at__hour__in=[0,1,2,3,4,5,22,23]
        ).select_related('doctor').order_by('-accessed_at')[:10]
        
        if after_hours:
            suspicious.append({
                'type': 'after_hours_access',
                'description': 'Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø± Ø³Ø§Ø¹Ø§Øª ØºÛŒØ±Ø§Ø¯Ø§Ø±ÛŒ',
                'logs': [self._serialize_access_log(log) for log in after_hours]
            })
            
        # Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ØªØ¹Ø¯Ø¯ Ø¯Ø± Ø²Ù…Ø§Ù† Ú©ÙˆØªØ§Ù‡
        rapid_access = await self._detect_rapid_access(patient_id)
        if rapid_access:
            suspicious.append({
                'type': 'rapid_access',
                'description': 'Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ØªØ¹Ø¯Ø¯ Ø¯Ø± Ø²Ù…Ø§Ù† Ú©ÙˆØªØ§Ù‡',
                'logs': rapid_access
            })
            
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§ÛŒ ÙØ§ÛŒÙ„
        bulk_downloads = await self._detect_bulk_downloads(patient_id)
        if bulk_downloads:
            suspicious.append({
                'type': 'bulk_download',
                'description': 'Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª',
                'logs': bulk_downloads
            })
            
        return suspicious
```

## ðŸ–¥ï¸ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ

### Patient Access Management UI

```python
# unified_access/api/views/patient_views.py
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response

class PatientAccessViewSet(viewsets.ModelViewSet):
    """API Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†"""
    
    serializer_class = AccessCodeSerializer
    permission_classes = [IsAuthenticated, IsPatient]
    
    def get_queryset(self):
        return AccessCode.objects.filter(
            patient=self.request.user,
            is_active=True
        ).order_by('-created_at')
        
    @action(detail=False, methods=['post'])
    async def generate_code(self, request):
        """ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¬Ø¯ÛŒØ¯"""
        
        serializer = GenerateAccessCodeSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        generator = AccessCodeGenerator()
        access_code = await generator.generate_access_code(
            patient_id=str(request.user.id),
            permissions=serializer.validated_data['permissions'],
            duration_hours=serializer.validated_data.get('duration_hours', 24),
            doctor_id=serializer.validated_data.get('doctor_id'),
            purpose=serializer.validated_data.get('purpose')
        )
        
        return Response({
            'code': access_code.code,
            'expires_at': access_code.expires_at.isoformat(),
            'permissions': access_code.permissions,
            'qr_code': self._generate_qr_code(access_code.code)
        }, status=status.HTTP_201_CREATED)
        
    @action(detail=True, methods=['post'])
    async def revoke(self, request, pk=None):
        """Ù„ØºÙˆ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ"""
        
        access_code = self.get_object()
        
        generator = AccessCodeGenerator()
        await generator.revoke_access_code(
            code_id=str(access_code.id),
            revoked_by=str(request.user.id),
            reason=request.data.get('reason')
        )
        
        return Response({
            'message': 'Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ØºÙˆ Ø´Ø¯'
        })
        
    @action(detail=False, methods=['get'])
    async def active_sessions(self, request):
        """Ø¯Ø±ÛŒØ§ÙØª Ø¬Ù„Ø³Ø§Øª ÙØ¹Ø§Ù„"""
        
        session_manager = AccessSessionManager()
        sessions = await session_manager.get_active_sessions(
            patient_id=str(request.user.id)
        )
        
        return Response({
            'sessions': sessions,
            'count': len(sessions)
        })
        
    @action(detail=False, methods=['post'])
    async def terminate_session(self, request):
        """Ø®Ø§ØªÙ…Ù‡ Ø¬Ù„Ø³Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ"""
        
        session_id = request.data.get('session_id')
        
        session = await AccessSession.objects.get(
            id=session_id,
            patient=request.user
        )
        
        session_manager = AccessSessionManager()
        await session_manager.terminate_session(
            session.session_token,
            'revoked'
        )
        
        return Response({
            'message': 'Ø¬Ù„Ø³Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§ØªÙ…Ù‡ ÛŒØ§ÙØª'
        })
        
    @action(detail=False, methods=['get'])
    async def access_report(self, request):
        """Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§"""
        
        audit_service = AccessAuditService()
        
        # Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ ÙÛŒÙ„ØªØ±
        start_date = request.query_params.get('start_date')
        end_date = request.query_params.get('end_date')
        doctor_id = request.query_params.get('doctor_id')
        
        report = await audit_service.get_access_report(
            patient_id=str(request.user.id),
            start_date=start_date,
            end_date=end_date,
            doctor_id=doctor_id
        )
        
        return Response(report)
        
    def _generate_qr_code(self, code: str) -> str:
        """ØªÙˆÙ„ÛŒØ¯ QR Code"""
        
        import qrcode
        from io import BytesIO
        import base64
        
        qr = qrcode.QRCode(
            version=1,
            error_correction=qrcode.constants.ERROR_CORRECT_L,
            box_size=10,
            border=4,
        )
        
        qr.add_data(f"HELSSA:{code}")
        qr.make(fit=True)
        
        img = qr.make_image(fill_color="black", back_color="white")
        
        buffer = BytesIO()
        img.save(buffer, format='PNG')
        
        return base64.b64encode(buffer.getvalue()).decode()
```

### Doctor Access UI

```python
# unified_access/api/views/doctor_views.py

class DoctorAccessViewSet(viewsets.ViewSet):
    """API Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø²Ø´Ú©Ø§Ù†"""
    
    permission_classes = [IsAuthenticated, IsDoctor]
    
    @action(detail=False, methods=['post'])
    async def verify_code(self, request):
        """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ"""
        
        code = request.data.get('code')
        
        if not code or len(code) != 6:
            return Response({
                'error': 'Ú©Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø§ÛŒØ¯ 6 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯'
            }, status=status.HTTP_400_BAD_REQUEST)
            
        validator = AccessCodeValidator()
        
        try:
            result = await validator.validate_access_code(
                code=code,
                doctor_id=str(request.user.id),
                device_info={
                    'ip_address': request.META.get('REMOTE_ADDR'),
                    'user_agent': request.META.get('HTTP_USER_AGENT'),
                    'device_id': request.data.get('device_id')
                }
            )
            
            return Response({
                'success': True,
                'session': result,
                'patient': {
                    'id': result['patient_id'],
                    'name': result['patient_name']
                },
                'permissions': result['permissions'],
                'expires_at': result['expires_at']
            })
            
        except InvalidAccessCode as e:
            return Response({
                'error': str(e)
            }, status=status.HTTP_400_BAD_REQUEST)
            
    @action(detail=False, methods=['get'])
    async def patient_data(self, request):
        """Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙ…Ø§Ø±"""
        
        session_token = request.headers.get('X-Access-Token')
        
        if not session_token:
            return Response({
                'error': 'ØªÙˆÚ©Ù† Ø¬Ù„Ø³Ù‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª'
            }, status=status.HTTP_401_UNAUTHORIZED)
            
        # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¬Ù„Ø³Ù‡
        session_manager = AccessSessionManager()
        session_data = await session_manager.validate_session(
            session_token
        )
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬ÙˆØ²Ù‡Ø§ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        patient_id = session_data['patient_id']
        permissions = session_data['permissions']
        
        response_data = {}
        
        # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡
        if AccessPermission.VIEW_BASIC_INFO in permissions:
            patient = await UnifiedUser.objects.get(id=patient_id)
            response_data['basic_info'] = {
                'name': patient.get_full_name(),
                'age': calculate_age(patient.birth_date),
                'gender': patient.get_gender_display(),
                'phone': patient.phone_number[:7] + '****'
            }
            
        # Ø³Ø§Ø¨Ù‚Ù‡ Ù¾Ø²Ø´Ú©ÛŒ
        if AccessPermission.VIEW_MEDICAL_HISTORY in permissions:
            # ... Ú©Ø¯ Ø¯Ø±ÛŒØ§ÙØª Ø³Ø§Ø¨Ù‚Ù‡
            pass
            
        # Ùˆ Ø³Ø§ÛŒØ± Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¬ÙˆØ²Ù‡Ø§...
        
        return Response(response_data)
```

## ðŸ”’ Ø§Ù…Ù†ÛŒØª Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§

### Security Measures

```python
# unified_access/utils/security.py

class AccessSecurityManager:
    """Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ù†ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§"""
    
    def __init__(self):
        self.rate_limiter = RateLimiter()
        self.geo_checker = GeoLocationChecker()
        
    async def validate_access_request(
        self,
        doctor_id: str,
        ip_address: str,
        user_agent: str
    ) -> Dict:
        """Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª"""
        
        validations = []
        
        # Ø¨Ø±Ø±Ø³ÛŒ rate limit
        rate_check = await self.rate_limiter.check_rate(
            f"access_code_verify:{doctor_id}",
            limit=10,
            window=300  # 10 ØªÙ„Ø§Ø´ Ø¯Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡
        )
        
        if not rate_check['allowed']:
            validations.append({
                'type': 'rate_limit',
                'message': f"ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø². {rate_check['retry_after']} Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯"
            })
            
        # Ø¨Ø±Ø±Ø³ÛŒ IP Ù…Ø´Ú©ÙˆÚ©
        ip_check = await self._check_suspicious_ip(ip_address)
        if ip_check['suspicious']:
            validations.append({
                'type': 'suspicious_ip',
                'message': 'Ø¢Ø¯Ø±Ø³ IP Ù…Ø´Ú©ÙˆÚ© ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯'
            })
            
        # Ø¨Ø±Ø±Ø³ÛŒ user agent
        if self._is_bot_user_agent(user_agent):
            validations.append({
                'type': 'bot_detected',
                'message': 'Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ bot Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª'
            })
            
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ
        geo_check = await self.geo_checker.check_location(ip_address)
        if geo_check['blocked']:
            validations.append({
                'type': 'geo_blocked',
                'message': f"Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² {geo_check['country']} Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª"
            })
            
        return {
            'valid': len(validations) == 0,
            'validations': validations
        }
        
    async def encrypt_session_data(
        self,
        session_data: Dict
    ) -> str:
        """Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ù„Ø³Ù‡"""
        
        # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ JSON
        json_data = json.dumps(session_data)
        
        # Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ AES
        cipher = Cipher(
            algorithms.AES(settings.SESSION_ENCRYPTION_KEY),
            modes.GCM(os.urandom(12))
        )
        
        encryptor = cipher.encryptor()
        ciphertext = encryptor.update(json_data.encode()) + encryptor.finalize()
        
        # Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙˆØ±Øª base64
        return base64.b64encode(
            encryptor.tag + ciphertext
        ).decode()
```

### Access Restrictions

```python
# unified_access/middleware/access_middleware.py

class AccessControlMiddleware:
    """Middleware Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ"""
    
    def __init__(self, get_response):
        self.get_response = get_response
        self.permission_checker = PermissionChecker()
        
    async def __call__(self, request):
        # Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ
        protected_patterns = [
            r'^/api/patients/(\w+)/medical-history',
            r'^/api/patients/(\w+)/lab-results',
            r'^/api/patients/(\w+)/prescriptions',
            r'^/api/encounters/(\w+)',
        ]
        
        for pattern in protected_patterns:
            match = re.match(pattern, request.path)
            if match:
                # Ø§Ø³ØªØ®Ø±Ø§Ø¬ session token
                session_token = request.headers.get('X-Access-Token')
                
                if not session_token:
                    # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¹Ø§Ø¯ÛŒ
                    if not request.user.is_authenticated:
                        return JsonResponse({
                            'error': 'Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª'
                        }, status=401)
                        
                    # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…
                    resource_id = match.group(1)
                    if not await self._has_direct_access(
                        request.user, resource_id
                    ):
                        return JsonResponse({
                            'error': 'Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ù…Ù†Ø¨Ø¹ Ù†Ø¯Ø§Ø±ÛŒØ¯'
                        }, status=403)
                else:
                    # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÙˆÙ‚Øª
                    try:
                        await self.permission_checker.check_permission(
                            session_token=session_token,
                            resource_type=self._get_resource_type(request.path),
                            resource_id=match.group(1),
                            action=self._get_action(request.method)
                        )
                    except (InvalidSession, PermissionDenied) as e:
                        return JsonResponse({
                            'error': str(e)
                        }, status=403)
                        
        response = self.get_response(request)
        return response
```

---

[ELEMENT: div align="center"]

[â†’ Ù‚Ø¨Ù„ÛŒ: ÙˆÛŒØ²ÛŒØª Ùˆ Ù…Ù„Ø§Ù‚Ø§Øªâ€ŒÙ‡Ø§](08-visits-encounters.md) | [Ø¨Ø¹Ø¯ÛŒ: Ú†Øªâ€ŒØ¨Ø§Øª Ù¾Ø²Ø´Ú©ÛŒ â†](10-chatbot-system.md)

</div>
