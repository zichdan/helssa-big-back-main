"""
ุฏุณุชูุฑ ูุฏุฑุช ุจุฑุง ุจุงุฑฺฏุฐุงุฑ ุฏุงุฏูโูุง ุงููู ฺุชโุจุงุช
Management command to load initial chatbot data
"""

from django.core.management.base import BaseCommand
from django.core.management import call_command
from chatbot.models import ChatbotResponse


class Command(BaseCommand):
    """
    ุฏุณุชูุฑ ุจุงุฑฺฏุฐุงุฑ ุฏุงุฏูโูุง ุงููู ฺุชโุจุงุช
    """
    help = 'ุจุงุฑฺฏุฐุงุฑ ุฏุงุฏูโูุง ุงููู ฺุชโุจุงุช ุดุงูู ูพุงุณุฎโูุง ุงุฒ ูพุด ุชุนุฑู ุดุฏู'
    
    def add_arguments(self, parser):
        """
        ุงูุฒูุฏู ุขุฑฺฏููุงูโูุง ุฎุท ูุฑูุงู ุจุฑุง ุฏุณุชูุฑ ูุฏุฑุช.
        
        ุงู ูุชุฏ ุฏู ุขุฑฺฏููุงู CLI ุฑุง ุจู parser ุงุถุงูู ูโฺฉูุฏ:
        - --reset: ููฺฏ ุจูู (action='store_true') ฺฉู ุฏุฑ ุตูุฑุช ุชุนูุ ูุจู ุงุฒ ุจุงุฑฺฏุฐุงุฑ ูฺฉุณฺุฑ ููู ุฑฺฉูุฑุฏูุง ChatbotResponse ุฑุง ุญุฐู ูโฺฉูุฏ.
        - --fixture: ูุงู ูุงู ูฺฉุณฺุฑ (ุฑุดุชู) ุจุฑุง ุจุงุฑฺฏุฐุงุฑุ ููุฏุงุฑ ูพุดโูุฑุถ 'initial_responses.json'.
        
        ูพุงุฑุงูุชุฑูุง:
        - parser: ูููููู argparse-like ฺฉู ุขุฑฺฏููุงูโูุง ุจู ุขู ุงุถุงูู ูโุดููุฏ.
        """
        parser.add_argument(
            '--reset',
            action='store_true',
            help='ุญุฐู ุฏุงุฏูโูุง ููุฌูุฏ ูุจู ุงุฒ ุจุงุฑฺฏุฐุงุฑ',
        )
        
        parser.add_argument(
            '--fixture',
            type=str,
            default='initial_responses.json',
            help='ูุงู ูุงู fixture ุจุฑุง ุจุงุฑฺฏุฐุงุฑ',
        )
    
    def handle(self, *args, **options):
        """
        ุงุฌุฑุง ูุฑูุงู ูุฏุฑุช ุจุฑุง ุจุงุฑฺฏุฐุงุฑ ุฏุงุฏูโูุง ุงููู ฺุชโุจุงุช.
        
        ุงู ูุชุฏ:
        - ุจูโุตูุฑุช ุงุฎุชุงุฑ ุชูุงู ุฑฺฉูุฑุฏูุง ูุฏู ChatbotResponse ุฑุง ุฏุฑ ุตูุฑุช ูุนุงู ุจูุฏู ฺฏุฒูู `reset` ุญุฐู ูโฺฉูุฏ.
        - ูุงู fixture ูุดุฎุตโุดุฏู ุชูุณุท ฺฏุฒูู `fixture` ุฑุง ุงุฒ ูุณุฑ `chatbot/fixtures/{fixture}` ุจุง ุงุณุชูุงุฏู ุงุฒ `loaddata` ุจุงุฑฺฏุฐุงุฑ ูโฺฉูุฏ.
        - ูพุณ ุงุฒ ุจุงุฑฺฏุฐุงุฑุ ุขูุงุฑ ฺฉู ุฑุง ูุญุงุณุจู ู ุจู ุฎุฑูุฌ ูโููุณุฏ (ุชุนุฏุงุฏ ฺฉู ูพุงุณุฎโูุง ู ุชุนุฏุงุฏ ูพุงุณุฎโูุง ูุนุงู).
        - ุขูุงุฑ ุชูฺฉฺฉโุดุฏูโ ุจุฑ ุงุณุงุณ ุฏุณุชูโุจูุฏโูุง ุฑุง ุจุง ูุฑุงุฎูุงู `_show_category_stats()` ููุงุด ูโุฏูุฏ.
        - ุฏุฑ ุตูุฑุช ูููุน ูุฑฺฏููู ุงุณุชุซูุง ููฺฏุงู ุจุงุฑฺฏุฐุงุฑุ ูพุงู ุฎุทุง ุฑุง ุจู ุฎุฑูุฌ ูโููุณุฏ ู ุงุฌุฑุง ูุชุฏ ุฑุง ุฎุงุชูู ูโุฏูุฏ.
        
        ฺฏุฒููโูุง ูุฑูุฏ (ุฏุฑ ุฏฺฉุดูุฑ `options`):
        - `reset` (bool): ุงฺฏุฑ True ุจุงุดุฏุ ูพุด ุงุฒ ุจุงุฑฺฏุฐุงุฑ fixture ูููู ูพุงุณุฎโูุง ููุฌูุฏ ุญุฐู ูโุดููุฏ.
        - `fixture` (str): ูุงู ูุงู fixture ฺฉู ุงุฒ ูุณุฑ `chatbot/fixtures/` ุจุงุฑฺฏุฐุงุฑ ูโุดูุฏ.
        
        ุงุซุฑุงุช ุฌุงูุจ:
        - ุญุฐู ุณุทุฑูุง ุฌุฏูู ChatbotResponse ุฏุฑ ุตูุฑุช ูุนุงูโุจูุฏู `reset`.
        - ุชุบุฑ ุฏุงุฏูโูุง ูพุงฺฏุงูโุฏุงุฏู ุจุง ุงุฌุฑุง ูุฑูุงู `loaddata`.
        - ููุดุชู ูพุงูโูุง ูุถุนุช ู ุขูุงุฑ ุฏุฑ ุฎุฑูุฌ ุงุณุชุงูุฏุงุฑุฏ ูุฑูุงู ูุฏุฑุช.
        """
        self.stdout.write(
            self.style.SUCCESS('ุดุฑูุน ุจุงุฑฺฏุฐุงุฑ ุฏุงุฏูโูุง ุงููู ฺุชโุจุงุช...')
        )
        
        # ุญุฐู ุฏุงุฏูโูุง ููุฌูุฏ ุฏุฑ ุตูุฑุช ุฏุฑุฎูุงุณุช
        if options['reset']:
            self.stdout.write('ุญุฐู ูพุงุณุฎโูุง ููุฌูุฏ...')
            ChatbotResponse.objects.all().delete()
            self.stdout.write(
                self.style.SUCCESS('โ ูพุงุณุฎโูุง ููุฌูุฏ ุญุฐู ุดุฏูุฏ')
            )
        
        # ุจุงุฑฺฏุฐุงุฑ fixture
        try:
            fixture_path = f'chatbot/fixtures/{options["fixture"]}'
            call_command('loaddata', fixture_path)
            
            # ุขูุงุฑฺฏุฑ
            total_responses = ChatbotResponse.objects.count()
            active_responses = ChatbotResponse.objects.filter(is_active=True).count()
            
            self.stdout.write(
                self.style.SUCCESS(
                    f'โ ุฏุงุฏูโูุง ุงููู ุจุง ููููุช ุจุงุฑฺฏุฐุงุฑ ุดุฏ\n'
                    f'  - ุชุนุฏุงุฏ ฺฉู ูพุงุณุฎโูุง: {total_responses}\n'
                    f'  - ูพุงุณุฎโูุง ูุนุงู: {active_responses}'
                )
            )
            
            # ููุงุด ุขูุงุฑ ุจุฑ ุงุณุงุณ ุฏุณุชูโุจูุฏ
            self._show_category_stats()
            
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'ุฎุทุง ุฏุฑ ุจุงุฑฺฏุฐุงุฑ ุฏุงุฏูโูุง: {str(e)}')
            )
            return
        
        self.stdout.write(
            self.style.SUCCESS('\n๐ ูุฑุขูุฏ ุจุงุฑฺฏุฐุงุฑ ุจุง ููููุช ุชฺฉูู ุดุฏ!')
        )
    
    def _show_category_stats(self):
        """
        ูุฏุฑ ู ุขูุงุฑ ุฏุณุชูโุจูุฏโุดุฏู ูพุงุณุฎโูุง ฺุชโุจุงุช ุฑุง ุฏุฑ ุฎุฑูุฌ ูุฏุฑุช ฺุงูพ ูโฺฉูุฏ.
        
        ุงู ูุชุฏ:
        - ฺฉ ุนููุงู ุจุฑุง ยซุขูุงุฑ ุจุฑ ุงุณุงุณ ุฏุณุชูโุจูุฏยป ุฏุฑ ุฎุฑูุฌ (self.stdout) ูโููุณุฏ.
        - ููู ููุงุฏุฑ ฺฉุชุง ููุฏ `category` ุฑุง ุงุฒ ูุฏู `ChatbotResponse` ูุงฺฉุด ูโฺฉูุฏ.
        - ุจุฑุง ูุฑ ุฏุณุชูุ ุดูุงุฑ ูพุงุณุฎโูุง ูุนุงู (`is_active=True`) ุฑุง ูุญุงุณุจู ูโฺฉูุฏ.
        - ฺฉูุฏ ุฏุณุชูโูุง ุฑุง ุจู ฺฉ ุจุฑฺุณุจ ูุงุฑุณ ูุงุจูโููู ูฺฏุงุดุช ูโฺฉูุฏ ู ุฏุฑ ุตูุฑุช ูุจูุฏ ูฺฏุงุดุชุ ุงุฒ ฺฉูุฏ ุฎุงู ุงุณุชูุงุฏู ูโฺฉูุฏ.
        - ูุฑ ุฎุท ุขูุงุฑ ุฑุง ุจู ุดฺฉู "  - {ุจุฑฺุณุจ}: {ุชุนุฏุงุฏ} ูพุงุณุฎ" ุจู ุฎุฑูุฌ ูโููุณุฏ.
        
        ุชุฃุซุฑุงุช ุฌุงูุจ:
        - ุฎุฑูุฌ ูุชู ุจู `self.stdout` ูโููุณุฏ.
        - ุงุฒ ูุฏู ูพุงฺฏุงูโุฏุงุฏู `ChatbotResponse` ุฎูุงูุฏู (queries) ุงูุฌุงู ูโุฏูุฏุ ูฺ ุชุบุฑ ุง ุญุฐู ุฏุงุฏูโุง ุงูุฌุงู ููโุฏูุฏ.
        """
        self.stdout.write('\nุขูุงุฑ ุจุฑ ุงุณุงุณ ุฏุณุชูโุจูุฏ:')
        
        categories = ChatbotResponse.objects.values_list('category', flat=True).distinct()
        
        for category in categories:
            count = ChatbotResponse.objects.filter(
                category=category, 
                is_active=True
            ).count()
            
            category_display = {
                'greeting': 'ุฎูุดุงูุฏฺฏู',
                'symptom_inquiry': 'ูพุฑุณุด ุนูุงุฆู',
                'medication_info': 'ุงุทูุงุนุงุช ุฏุงุฑู',
                'appointment': 'ููุจุชโฺฏุฑ',
                'emergency': 'ุงูุฑฺุงูุณ',
                'general_health': 'ุณูุงูุช ุนููู',
                'farewell': 'ุฎุฏุงุญุงูุธ',
                'error': 'ุฎุทุง',
                'unknown': 'ูุงูุดุฎุต'
            }.get(category, category)
            
            self.stdout.write(f'  - {category_display}: {count} ูพุงุณุฎ')