# ğŸ“„ ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ùˆ Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± HELSSA

## ğŸ“‹ ÙÙ‡Ø±Ø³Øª Ù…Ø·Ø§Ù„Ø¨

- [Ù…Ø¹Ø±ÙÛŒ Ø³ÛŒØ³ØªÙ… ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´](## ğŸ¯ Ù…Ø¹Ø±ÙÛŒ Ø³ÛŒØ³ØªÙ… ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´)
- [Ù…Ø¹Ù…Ø§Ø±ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø®Ø±ÙˆØ¬ÛŒ](## ğŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø®Ø±ÙˆØ¬ÛŒ)
- [ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ SOAP](## ğŸ“ ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ SOAP)
- [Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ Ùˆ ÙØ±Ù…Øªâ€ŒÙ‡Ø§](## ğŸ“ Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ Ùˆ ÙØ±Ù…Øªâ€ŒÙ‡Ø§)
- [ØªÙˆÙ„ÛŒØ¯ PDF Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ](## ğŸ“ ØªÙˆÙ„ÛŒØ¯ PDF Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ)
- [ØªÙˆÙ„ÛŒØ¯ Ù†Ø³Ø®Ù‡ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©](## ğŸ“ ØªÙˆÙ„ÛŒØ¯ Ù†Ø³Ø®Ù‡ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©)
- [Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„](## ğŸ“ Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„)
- [Ø³ÙØ§Ø±Ø´ÛŒâ€ŒØ³Ø§Ø²ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§](## ğŸ“ Ø³ÙØ§Ø±Ø´ÛŒâ€ŒØ³Ø§Ø²ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§)

---

## ğŸ¯ Ù…Ø¹Ø±ÙÛŒ Ø³ÛŒØ³ØªÙ… ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´

Ø³ÛŒØ³ØªÙ… ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ HELSSA ÛŒÚ© Ù¾Ù„ØªÙØ±Ù… Ø¬Ø§Ù…Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù†ÙˆØ§Ø¹ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù¾Ø²Ø´Ú©ÛŒØŒ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ Ùˆ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§ Ùˆ Ù‚Ø§Ø¨Ù„ÛŒØª Ø³ÙØ§Ø±Ø´ÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø§Ø³Øª.

### ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ

- ğŸ“ **ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø± SOAP** Ø§Ø² Ø±ÙˆÙ†ÙˆÛŒØ³ÛŒ Ù…Ù„Ø§Ù‚Ø§Øª
- ğŸ¨ **Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ** Ù‚Ø§Ø¨Ù„ Ø³ÙØ§Ø±Ø´ÛŒâ€ŒØ³Ø§Ø²ÛŒ
- ğŸ“‘ **Ø®Ø±ÙˆØ¬ÛŒ Ú†Ù†Ø¯ÙØ±Ù…ØªÙ‡** (PDF, Word, HTML, Markdown)
- âœï¸ **Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„** Ù…Ø¹ØªØ¨Ø±
- ğŸ’Š **Ù†Ø³Ø®Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©** Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯
- ğŸ¥ **Ø¨Ø±Ù†Ø¯ÛŒÙ†Ú¯** Ø¨Ø±Ø§ÛŒ Ú©Ù„ÛŒÙ†ÛŒÚ©â€ŒÙ‡Ø§
- ğŸŒ **Ú†Ù†Ø¯Ø²Ø¨Ø§Ù†Ù‡** (ÙØ§Ø±Ø³ÛŒØŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø¹Ø±Ø¨ÛŒ)
- ğŸ“± **Responsive** Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„

## ğŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø®Ø±ÙˆØ¬ÛŒ

```mermaid
graph TB
    subgraph "Data Sources"
        ENC[Encounter Data]
        TRANS[Transcript]
        PAT[Patient Info]
        DOC[Doctor Info]
    end
    
    subgraph "Processing Layer"
        SOAP[SOAP Generator]
        TEMP[Template Engine]
        FORM[Formatter]
        VALID[Validator]
    end
    
    subgraph "Generation Layer"
        PDF[PDF Generator]
        WORD[Word Generator]
        HTML[HTML Generator]
        MARK[Markdown Generator]
    end
    
    subgraph "Enhancement Layer"
        BRAND[Branding Service]
        SIGN[Digital Signature]
        QR[QR Code Generator]
        WATER[Watermark Service]
    end
    
    subgraph "Output Layer"
        STORE[Storage Service]
        SHARE[Share Service]
        PRINT[Print Service]
        EMAIL[Email Service]
    end
    
    ENC --> SOAP
    TRANS --> SOAP
    PAT --> TEMP
    DOC --> TEMP
    
    SOAP --> TEMP
    TEMP --> FORM
    FORM --> VALID
    
    VALID --> PDF
    VALID --> WORD
    VALID --> HTML
    VALID --> MARK
    
    PDF --> BRAND
    BRAND --> SIGN
    SIGN --> QR
    QR --> WATER
    
    WATER --> STORE
    STORE --> SHARE
    STORE --> PRINT
    STORE --> EMAIL
```

### Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø±ÙˆÚ˜Ù‡

```python
outputs/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ report_template.py      # Ù…Ø¯Ù„ Ù‚Ø§Ù„Ø¨ Ú¯Ø²Ø§Ø±Ø´
â”‚   â”œâ”€â”€ generated_report.py     # Ù…Ø¯Ù„ Ú¯Ø²Ø§Ø±Ø´ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡
â”‚   â”œâ”€â”€ prescription.py         # Ù…Ø¯Ù„ Ù†Ø³Ø®Ù‡
â”‚   â””â”€â”€ report_settings.py      # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú¯Ø²Ø§Ø±Ø´
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ soap_generator.py       # ØªÙˆÙ„ÛŒØ¯ SOAP
â”‚   â”œâ”€â”€ template_engine.py      # Ù…ÙˆØªÙˆØ± Ù‚Ø§Ù„Ø¨
â”‚   â”œâ”€â”€ pdf_generator.py        # ØªÙˆÙ„ÛŒØ¯ PDF
â”‚   â”œâ”€â”€ word_generator.py       # ØªÙˆÙ„ÛŒØ¯ Word
â”‚   â”œâ”€â”€ prescription_generator.py # ØªÙˆÙ„ÛŒØ¯ Ù†Ø³Ø®Ù‡
â”‚   â””â”€â”€ signature_service.py    # Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ soap/                   # Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ SOAP
â”‚   â”œâ”€â”€ prescription/           # Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ù†Ø³Ø®Ù‡
â”‚   â”œâ”€â”€ reports/               # Ø³Ø§ÛŒØ± Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§
â”‚   â””â”€â”€ emails/                # Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ…ÛŒÙ„
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ fonts/                 # ÙÙˆÙ†Øªâ€ŒÙ‡Ø§
â”‚   â”œâ”€â”€ images/               # ØªØµØ§ÙˆÛŒØ± Ùˆ Ù„ÙˆÚ¯ÙˆÙ‡Ø§
â”‚   â””â”€â”€ styles/               # Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ formatters.py         # ÙØ±Ù…Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§
â”‚   â”œâ”€â”€ validators.py         # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
â”‚   â””â”€â”€ converters.py         # ØªØ¨Ø¯ÛŒÙ„â€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§
â””â”€â”€ api/
    â”œâ”€â”€ views.py
    â””â”€â”€ serializers.py
```

## ğŸ“ ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ SOAP

### SOAP Generator Service

```python
# outputs/services/soap_generator.py
from typing import Dict, List, Optional
import asyncio
from datetime import datetime

class SOAPGenerator:
    """ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ú¯Ø²Ø§Ø±Ø´ SOAP"""
    
    def __init__(self):
        self.ai_service = UnifiedAIService()
        self.medical_analyzer = MedicalAnalyzer()
        self.template_engine = TemplateEngine()
        self.validator = SOAPValidator()
        
    async def generate_soap_report(
        self,
        encounter_id: str,
        regenerate: bool = False
    ) -> GeneratedReport:
        """ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ SOAP Ø§Ø² Ù…Ù„Ø§Ù‚Ø§Øª"""
        
        # Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        encounter = await self._get_encounter_data(encounter_id)
        transcript = await self._get_transcript(encounter_id)
        patient = await self._get_patient_info(encounter.patient_id)
        doctor = await self._get_doctor_info(encounter.doctor_id)
        
        # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ context
        context = {
            'encounter': encounter,
            'transcript': transcript,
            'patient': patient,
            'doctor': doctor,
            'chief_complaint': encounter.chief_complaint,
            'visit_date': encounter.scheduled_at,
            'duration': encounter.actual_duration
        }
        
        # ØªÙˆÙ„ÛŒØ¯ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ SOAP
        soap_sections = await self._generate_soap_sections(context)
        
        # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
        validation_result = await self.validator.validate_soap(soap_sections)
        if not validation_result['valid']:
            soap_sections = await self._fix_validation_issues(
                soap_sections,
                validation_result['issues']
            )
            
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø®ØªØ§Ø±ÛŒØ§ÙØªÙ‡
        structured_data = await self._extract_structured_data(soap_sections)
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø²Ø§Ø±Ø´
        report = await GeneratedReport.objects.create(
            encounter_id=encounter_id,
            report_type='soap',
            content=soap_sections,
            structured_data=structured_data,
            metadata={
                'generator_version': '2.0',
                'ai_model': 'gpt-4',
                'confidence_score': validation_result.get('confidence', 0.85)
            }
        )
        
        # ØªÙˆÙ„ÛŒØ¯ ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
        await self._generate_output_formats(report)
        
        return report
        
    async def _generate_soap_sections(self, context: Dict) -> Dict:
        """ØªÙˆÙ„ÛŒØ¯ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ SOAP"""
        
        # ØªÙˆÙ„ÛŒØ¯ Ù…ÙˆØ§Ø²ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§
        sections = await asyncio.gather(
            self._generate_subjective(context),
            self._generate_objective(context),
            self._generate_assessment(context),
            self._generate_plan(context)
        )
        
        return {
            'subjective': sections[0],
            'objective': sections[1],
            'assessment': sections[2],
            'plan': sections[3]
        }
        
    async def _generate_subjective(self, context: Dict) -> Dict:
        """ØªÙˆÙ„ÛŒØ¯ Ø¨Ø®Ø´ Subjective"""
        
        prompt = f"""Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÙˆÙ†ÙˆÛŒØ³ÛŒ Ù…Ù„Ø§Ù‚Ø§Øª Ù¾Ø²Ø´Ú©ÛŒØŒ Ø¨Ø®Ø´ Subjective Ú¯Ø²Ø§Ø±Ø´ SOAP Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯.

Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±:
- Ù†Ø§Ù…: {context['patient']['name']}
- Ø³Ù†: {context['patient']['age']} Ø³Ø§Ù„
- Ø¬Ù†Ø³ÛŒØª: {context['patient']['gender']}

Ø´Ú©Ø§ÛŒØª Ø§ØµÙ„ÛŒ: {context['chief_complaint']}

Ø±ÙˆÙ†ÙˆÛŒØ³ÛŒ Ù…Ú©Ø§Ù„Ù…Ù‡:
{context['transcript'][:2000]}

Ø¨Ø®Ø´ Subjective Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„:
1. Chief Complaint (CC) - Ø´Ú©Ø§ÛŒØª Ø§ØµÙ„ÛŒ
2. History of Present Illness (HPI) Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª OLDCARTS:
   - Onset (Ø´Ø±ÙˆØ¹)
   - Location (Ù…Ø­Ù„)
   - Duration (Ù…Ø¯Øª)
   - Character (ÙˆÛŒÚ˜Ú¯ÛŒ)
   - Aggravating factors (Ø¹ÙˆØ§Ù…Ù„ ØªØ´Ø¯ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡)
   - Relieving factors (Ø¹ÙˆØ§Ù…Ù„ ØªØ³Ú©ÛŒÙ†â€ŒØ¯Ù‡Ù†Ø¯Ù‡)
   - Timing (Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ)
   - Severity (Ø´Ø¯Øª 1-10)
3. Review of Systems (ROS) - Ù…Ø±ÙˆØ± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§
4. Past Medical History (PMH) - Ø³Ø§Ø¨Ù‚Ù‡ Ù¾Ø²Ø´Ú©ÛŒ
5. Medications - Ø¯Ø§Ø±ÙˆÙ‡Ø§ÛŒ Ù…ØµØ±ÙÛŒ
6. Allergies - Ø¢Ù„Ø±Ú˜ÛŒâ€ŒÙ‡Ø§
7. Social History - Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ (Ø¯Ø± ØµÙˆØ±Øª Ø§Ø±ØªØ¨Ø§Ø·)
8. Family History - Ø³Ø§Ø¨Ù‚Ù‡ Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ (Ø¯Ø± ØµÙˆØ±Øª Ø°Ú©Ø±)

Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª JSON Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ù‚ÛŒÙ‚ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯."""

        response = await self.ai_service.generate_structured_response(
            prompt,
            response_format={
                "type": "json_object",
                "schema": {
                    "chief_complaint": "string",
                    "hpi": {
                        "onset": "string",
                        "location": "string",
                        "duration": "string",
                        "character": "string",
                        "aggravating_factors": ["string"],
                        "relieving_factors": ["string"],
                        "timing": "string",
                        "severity": "number"
                    },
                    "ros": ["string"],
                    "pmh": ["string"],
                    "medications": ["string"],
                    "allergies": ["string"],
                    "social_history": "string",
                    "family_history": "string"
                }
            }
        )
        
        return response['data']
        
    async def _generate_objective(self, context: Dict) -> Dict:
        """ØªÙˆÙ„ÛŒØ¯ Ø¨Ø®Ø´ Objective"""
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹ÛŒÙ†ÛŒ Ø§Ø² Ø±ÙˆÙ†ÙˆÛŒØ³ÛŒ
        vital_signs = await self._extract_vital_signs(context['transcript'])
        physical_exam = await self._extract_physical_exam(context['transcript'])
        lab_results = await self._get_recent_lab_results(context['patient']['id'])
        
        return {
            'vital_signs': vital_signs,
            'physical_examination': physical_exam,
            'laboratory_results': lab_results,
            'imaging_results': [],
            'other_findings': []
        }
        
    async def _generate_assessment(self, context: Dict) -> Dict:
        """ØªÙˆÙ„ÛŒØ¯ Ø¨Ø®Ø´ Assessment"""
        
        prompt = f"""Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Subjective Ùˆ ObjectiveØŒ Ø¨Ø®Ø´ Assessment Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯.

Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„:
1. Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ø§Ø±
2. ØªØ´Ø®ÛŒØµâ€ŒÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ (Differential Diagnoses) Ø¨Ø§ Ú©Ø¯ ICD-10
3. ØªØ´Ø®ÛŒØµ Ø§ØµÙ„ÛŒ (Primary Diagnosis)
4. Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±ÛŒØ³Ú© Ùˆ Ù¾ÛŒØ´â€ŒØ¢Ú¯Ù‡ÛŒ

Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:
{json.dumps(context, ensure_ascii=False, indent=2)[:1500]}

Ø®Ø±ÙˆØ¬ÛŒ JSON:"""

        response = await self.ai_service.generate_structured_response(prompt)
        
        return response['data']
        
    async def _generate_plan(self, context: Dict) -> Dict:
        """ØªÙˆÙ„ÛŒØ¯ Ø¨Ø®Ø´ Plan"""
        
        return {
            'medications': await self._generate_prescriptions(context),
            'laboratory_orders': await self._generate_lab_orders(context),
            'imaging_orders': [],
            'procedures': [],
            'referrals': await self._generate_referrals(context),
            'patient_education': await self._generate_education(context),
            'follow_up': await self._generate_follow_up(context),
            'precautions': []
        }
```

### SOAP Formatter

```python
# outputs/services/soap_formatter.py

class SOAPFormatter:
    """ÙØ±Ù…Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ú¯Ø²Ø§Ø±Ø´ SOAP"""
    
    def __init__(self):
        self.text_formatter = TextFormatter()
        self.medical_formatter = MedicalTermFormatter()
        
    async def format_soap_report(
        self,
        soap_data: Dict,
        format_type: str = 'structured'
    ) -> str:
        """ÙØ±Ù…Øªâ€ŒØ¯Ù‡ÛŒ Ú¯Ø²Ø§Ø±Ø´ SOAP"""
        
        if format_type == 'structured':
            return await self._format_structured(soap_data)
        elif format_type == 'narrative':
            return await self._format_narrative(soap_data)
        elif format_type == 'clinical':
            return await self._format_clinical(soap_data)
        else:
            raise ValueError(f"Unknown format type: {format_type}")
            
    async def _format_structured(self, soap_data: Dict) -> str:
        """ÙØ±Ù…Øª Ø³Ø§Ø®ØªØ§Ø±ÛŒØ§ÙØªÙ‡"""
        
        formatted = []
        
        # Subjective
        formatted.append("## SUBJECTIVE\n")
        formatted.append(f"**Chief Complaint:** {soap_data['subjective']['chief_complaint']}\n")
        
        formatted.append("\n**History of Present Illness:**")
        hpi = soap_data['subjective']['hpi']
        formatted.append(f"- Onset: {hpi['onset']}")
        formatted.append(f"- Location: {hpi['location']}")
        formatted.append(f"- Duration: {hpi['duration']}")
        formatted.append(f"- Character: {hpi['character']}")
        formatted.append(f"- Severity: {hpi['severity']}/10")
        
        if soap_data['subjective']['pmh']:
            formatted.append("\n**Past Medical History:**")
            for item in soap_data['subjective']['pmh']:
                formatted.append(f"- {item}")
                
        # Objective
        formatted.append("\n## OBJECTIVE\n")
        if soap_data['objective']['vital_signs']:
            formatted.append("**Vital Signs:**")
            vs = soap_data['objective']['vital_signs']
            formatted.append(f"- BP: {vs.get('blood_pressure', 'N/A')}")
            formatted.append(f"- HR: {vs.get('heart_rate', 'N/A')}")
            formatted.append(f"- RR: {vs.get('respiratory_rate', 'N/A')}")
            formatted.append(f"- Temp: {vs.get('temperature', 'N/A')}")
            formatted.append(f"- SpO2: {vs.get('oxygen_saturation', 'N/A')}")
            
        # Assessment
        formatted.append("\n## ASSESSMENT\n")
        for i, dx in enumerate(soap_data['assessment']['diagnoses'], 1):
            formatted.append(f"{i}. {dx['description']} (ICD-10: {dx['icd_code']})")
            
        # Plan
        formatted.append("\n## PLAN\n")
        
        if soap_data['plan']['medications']:
            formatted.append("\n**Medications:**")
            for med in soap_data['plan']['medications']:
                formatted.append(
                    f"- {med['name']} {med['dosage']} - "
                    f"{med['route']} {med['frequency']} x {med['duration']}"
                )
                
        if soap_data['plan']['follow_up']:
            formatted.append(f"\n**Follow-up:** {soap_data['plan']['follow_up']}")
            
        return '\n'.join(formatted)
```

## ğŸ¨ Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ Ùˆ ÙØ±Ù…Øªâ€ŒÙ‡Ø§

### Template Engine

```python
# outputs/services/template_engine.py
from jinja2 import Environment, FileSystemLoader, select_autoescape
import os

class TemplateEngine:
    """Ù…ÙˆØªÙˆØ± Ù‚Ø§Ù„Ø¨ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§"""
    
    def __init__(self):
        self.env = Environment(
            loader=FileSystemLoader('outputs/templates'),
            autoescape=select_autoescape(['html', 'xml']),
            enable_async=True
        )
        self._register_filters()
        self._register_functions()
        
    def _register_filters(self):
        """Ø«Ø¨Øª ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ"""
        
        # ÙÛŒÙ„ØªØ± ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
        self.env.filters['jalali'] = self._jalali_date
        
        # ÙÛŒÙ„ØªØ± Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ
        self.env.filters['persian_number'] = self._persian_number
        
        # ÙÛŒÙ„ØªØ± ÙˆØ§Ø­Ø¯ Ø¯Ø§Ø±ÙˆÛŒÛŒ
        self.env.filters['drug_unit'] = self._format_drug_unit
        
    async def render_template(
        self,
        template_name: str,
        context: Dict,
        locale: str = 'fa'
    ) -> str:
        """Ø±Ù†Ø¯Ø± Ù‚Ø§Ù„Ø¨"""
        
        # Ø§ÙØ²ÙˆØ¯Ù† Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ
        context.update({
            'locale': locale,
            'current_date': datetime.now(),
            'platform_name': 'HELSSA',
            'support_phone': settings.SUPPORT_PHONE,
            'support_email': settings.SUPPORT_EMAIL
        })
        
        # Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨ Ø¨Ø± Ø§Ø³Ø§Ø³ locale
        if locale != 'fa':
            template_name = f"{locale}/{template_name}"
            
        template = self.env.get_template(template_name)
        return await template.render_async(**context)
        
    def _jalali_date(self, date, format='%Y/%m/%d'):
        """ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ"""
        
        if not date:
            return ''
            
        # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² jdatetime
        import jdatetime
        
        if isinstance(date, str):
            date = datetime.fromisoformat(date)
            
        jalali = jdatetime.date.fromgregorian(
            day=date.day,
            month=date.month,
            year=date.year
        )
        
        return jalali.strftime(format)
        
    def _persian_number(self, number):
        """ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ"""
        
        persian_digits = 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'
        english_digits = '0123456789'
        
        translation_table = str.maketrans(english_digits, persian_digits)
        return str(number).translate(translation_table)
```

### Report Templates

```html
<!-- outputs/templates/soap/report.html -->
<!DOCTYPE html>
<html lang="{{ locale }}" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú¯Ø²Ø§Ø±Ø´ Ù¾Ø²Ø´Ú©ÛŒ - {{ patient.name }}</title>
    <style>
        @font-face {
            font-family: 'Vazir';
            src: url('/static/fonts/Vazir.ttf');
        }
        
        body {
            font-family: 'Vazir', sans-serif;
            line-height: 1.8;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .logo {
            height: 60px;
        }
        
        .clinic-info {
            text-align: left;
            font-size: 12px;
            color: #666;
        }
        
        .patient-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .patient-info table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .patient-info td {
            padding: 5px 10px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #0066cc;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            font-size: 18px;
        }
        
        .medications {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }
        
        .medication-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-right: 3px solid #0066cc;
        }
        
        .signature-section {
            margin-top: 50px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        
        .doctor-signature {
            text-align: center;
            width: 200px;
        }
        
        .signature-line {
            border-top: 1px solid #333;
            margin-top: 50px;
            padding-top: 10px;
        }
        
        .qr-code {
            width: 100px;
            height: 100px;
        }
        
        @media print {
            body {
                margin: 0;
                padding: 10px;
            }
            
            .section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <img src="{{ clinic.logo_url }}" alt="{{ clinic.name }}" class="logo">
        <div class="clinic-info">
            <strong>{{ clinic.name }}</strong><br>
            {{ clinic.address }}<br>
            ØªÙ„ÙÙ†: {{ clinic.phone }}<br>
            {{ current_date|jalali }}
        </div>
    </div>
    
    <!-- Patient Information -->
    <div class="patient-info">
        <table>
            <tr>
                <td><strong>Ù†Ø§Ù… Ø¨ÛŒÙ…Ø§Ø±:</strong> {{ patient.name }}</td>
                <td><strong>Ú©Ø¯ Ù…Ù„ÛŒ:</strong> {{ patient.national_id }}</td>
                <td><strong>Ø³Ù†:</strong> {{ patient.age }} Ø³Ø§Ù„</td>
            </tr>
            <tr>
                <td><strong>Ø¬Ù†Ø³ÛŒØª:</strong> {{ patient.gender }}</td>
                <td><strong>ØªÙ„ÙÙ†:</strong> {{ patient.phone }}</td>
                <td><strong>ØªØ§Ø±ÛŒØ® ÙˆÛŒØ²ÛŒØª:</strong> {{ encounter.date|jalali }}</td>
            </tr>
        </table>
    </div>
    
    <!-- SOAP Sections -->
    <div class="section">
        <h2>Ø´Ø±Ø­ Ø­Ø§Ù„ (Subjective)</h2>
        <p><strong>Ø´Ú©Ø§ÛŒØª Ø§ØµÙ„ÛŒ:</strong> {{ soap.subjective.chief_complaint }}</p>
        
        <p><strong>ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨ÛŒÙ…Ø§Ø±ÛŒ ÙØ¹Ù„ÛŒ:</strong></p>
        <div class="hpi">
            {{ soap.subjective.hpi|format_hpi }}
        </div>
        
        {% if soap.subjective.pmh %}
        <p><strong>Ø³Ø§Ø¨Ù‚Ù‡ Ù¾Ø²Ø´Ú©ÛŒ:</strong></p>
        <ul>
            {% for item in soap.subjective.pmh %}
            <li>{{ item }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    
    <div class="section">
        <h2>Ù…Ø¹Ø§ÛŒÙ†Ù‡ (Objective)</h2>
        
        {% if soap.objective.vital_signs %}
        <p><strong>Ø¹Ù„Ø§Ø¦Ù… Ø­ÛŒØ§ØªÛŒ:</strong></p>
        <table class="vital-signs">
            <tr>
                <td>ÙØ´Ø§Ø± Ø®ÙˆÙ†: {{ soap.objective.vital_signs.blood_pressure }}</td>
                <td>Ø¶Ø±Ø¨Ø§Ù† Ù‚Ù„Ø¨: {{ soap.objective.vital_signs.heart_rate }}</td>
                <td>ØªÙ†ÙØ³: {{ soap.objective.vital_signs.respiratory_rate }}</td>
            </tr>
            <tr>
                <td>Ø¯Ù…Ø§: {{ soap.objective.vital_signs.temperature }}</td>
                <td>Ø§Ø´Ø¨Ø§Ø¹ Ø§Ú©Ø³ÛŒÚ˜Ù†: {{ soap.objective.vital_signs.oxygen_saturation }}</td>
                <td>ÙˆØ²Ù†: {{ soap.objective.vital_signs.weight }}</td>
            </tr>
        </table>
        {% endif %}
        
        {% if soap.objective.physical_examination %}
        <p><strong>Ù…Ø¹Ø§ÛŒÙ†Ù‡ ÙÛŒØ²ÛŒÚ©ÛŒ:</strong></p>
        {{ soap.objective.physical_examination|safe }}
        {% endif %}
    </div>
    
    <div class="section">
        <h2>Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ (Assessment)</h2>
        <ol>
            {% for diagnosis in soap.assessment.diagnoses %}
            <li>
                {{ diagnosis.description }}
                {% if diagnosis.icd_code %}
                <span class="icd-code">(ICD-10: {{ diagnosis.icd_code }})</span>
                {% endif %}
            </li>
            {% endfor %}
        </ol>
    </div>
    
    <div class="section">
        <h2>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø±Ù…Ø§Ù† (Plan)</h2>
        
        {% if soap.plan.medications %}
        <div class="medications">
            <h3>Ø¯Ø§Ø±ÙˆÙ‡Ø§:</h3>
            {% for med in soap.plan.medications %}
            <div class="medication-item">
                <strong>{{ loop.index|persian_number }}. {{ med.name }}</strong><br>
                Ø¯ÙˆØ²: {{ med.dosage }}<br>
                Ø±ÙˆØ´ Ù…ØµØ±Ù: {{ med.route }}<br>
                ØªØ¹Ø¯Ø§Ø¯/Ù…Ø¯Øª: {{ med.frequency }} - {{ med.duration }}<br>
                {% if med.instructions %}
                ØªÙˆØ¶ÛŒØ­Ø§Øª: {{ med.instructions }}
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        {% if soap.plan.lab_orders %}
        <p><strong>Ø¢Ø²Ù…Ø§ÛŒØ´Ø§Øª Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ:</strong></p>
        <ul>
            {% for lab in soap.plan.lab_orders %}
            <li>{{ lab }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        
        {% if soap.plan.follow_up %}
        <p><strong>Ù¾ÛŒÚ¯ÛŒØ±ÛŒ:</strong> {{ soap.plan.follow_up }}</p>
        {% endif %}
    </div>
    
    <!-- Signature Section -->
    <div class="signature-section">
        <div class="qr-code">
            <img src="{{ qr_code_url }}" alt="QR Code">
        </div>
        
        <div class="doctor-signature">
            <div class="signature-line">
                Ø¯Ú©ØªØ± {{ doctor.name }}<br>
                ØªØ®ØµØµ: {{ doctor.specialty }}<br>
                Ø´Ù…Ø§Ø±Ù‡ Ù†Ø¸Ø§Ù… Ù¾Ø²Ø´Ú©ÛŒ: {{ doctor.medical_id }}
            </div>
        </div>
    </div>
</body>
</html>
```

## ğŸ“‘ ØªÙˆÙ„ÛŒØ¯ PDF Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ

### PDF Generator Service

```python
# outputs/services/pdf_generator.py
from reportlab.lib import colors
from reportlab.lib.pagesizes import A4
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.units import cm
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
import arabic_reshaper
from bidi.algorithm import get_display

class PDFGenerator:
    """ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ PDF Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ"""
    
    def __init__(self):
        self._register_fonts()
        self.styles = self._create_styles()
        
    def _register_fonts(self):
        """Ø«Ø¨Øª ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ"""
        
        # Ø«Ø¨Øª ÙÙˆÙ†Øª Vazir
        pdfmetrics.registerFont(
            TTFont('Vazir', 'outputs/static/fonts/Vazir.ttf')
        )
        pdfmetrics.registerFont(
            TTFont('Vazir-Bold', 'outputs/static/fonts/Vazir-Bold.ttf')
        )
        
    def _create_styles(self):
        """Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ"""
        
        styles = getSampleStyleSheet()
        
        # Ø§Ø³ØªØ§ÛŒÙ„ Ø¹Ù†ÙˆØ§Ù†
        styles.add(ParagraphStyle(
            name='PersianTitle',
            fontName='Vazir-Bold',
            fontSize=16,
            leading=20,
            alignment=1,  # Center
            textColor=colors.HexColor('#0066cc')
        ))
        
        # Ø§Ø³ØªØ§ÛŒÙ„ Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ
        styles.add(ParagraphStyle(
            name='PersianNormal',
            fontName='Vazir',
            fontSize=12,
            leading=18,
            alignment=2,  # Right
            wordWrap='RTL'
        ))
        
        # Ø§Ø³ØªØ§ÛŒÙ„ Ù†Ø³Ø®Ù‡
        styles.add(ParagraphStyle(
            name='Prescription',
            fontName='Vazir',
            fontSize=11,
            leading=16,
            alignment=2,
            leftIndent=20,
            backColor=colors.HexColor('#f5f5f5')
        ))
        
        return styles
        
    async def generate_pdf(
        self,
        report: GeneratedReport,
        output_path: str
    ) -> str:
        """ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ PDF"""
        
        # Ø§ÛŒØ¬Ø§Ø¯ document
        doc = SimpleDocTemplate(
            output_path,
            pagesize=A4,
            rightMargin=2*cm,
            leftMargin=2*cm,
            topMargin=2*cm,
            bottomMargin=2*cm,
            title=f"Ú¯Ø²Ø§Ø±Ø´ Ù¾Ø²Ø´Ú©ÛŒ - {report.encounter.patient.name}",
            author="HELSSA Platform"
        )
        
        # Ø³Ø§Ø®Øª Ù…Ø­ØªÙˆØ§
        story = []
        
        # Ø§ÙØ²ÙˆØ¯Ù† header
        story.extend(await self._create_header(report))
        
        # Ø§ÙØ²ÙˆØ¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒÙ…Ø§Ø±
        story.extend(await self._create_patient_info(report))
        
        # Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ SOAP
        story.extend(await self._create_soap_sections(report))
        
        # Ø§ÙØ²ÙˆØ¯Ù† Ù†Ø³Ø®Ù‡
        if report.content.get('plan', {}).get('medications'):
            story.extend(await self._create_prescription(report))
            
        # Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù…Ø¶Ø§
        story.extend(await self._create_signature(report))
        
        # Ø³Ø§Ø®Øª PDF
        doc.build(story, onFirstPage=self._add_page_elements)
        
        return output_path
        
    async def _create_header(self, report: GeneratedReport) -> List:
        """Ø§ÛŒØ¬Ø§Ø¯ header"""
        
        story = []
        
        # Ø¬Ø¯ÙˆÙ„ header
        header_data = [
            [
                self._format_persian("Ú©Ù„ÛŒÙ†ÛŒÚ© " + report.encounter.doctor.clinic.name),
                Image(report.encounter.doctor.clinic.logo_path, width=3*cm, height=3*cm)
            ]
        ]
        
        header_table = Table(header_data, colWidths=[12*cm, 5*cm])
        header_table.setStyle(TableStyle([
            ('ALIGN', (0, 0), (0, 0), 'RIGHT'),
            ('ALIGN', (1, 0), (1, 0), 'LEFT'),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
            ('FONTNAME', (0, 0), (0, 0), 'Vazir-Bold'),
            ('FONTSIZE', (0, 0), (0, 0), 14),
        ]))
        
        story.append(header_table)
        story.append(Spacer(1, 0.5*cm))
        
        # Ø®Ø· Ø¬Ø¯Ø§ Ú©Ù†Ù†Ø¯Ù‡
        story.append(HRFlowable(
            width="100%",
            thickness=2,
            color=colors.HexColor('#0066cc')
        ))
        
        story.append(Spacer(1, 0.5*cm))
        
        return story
        
    def _format_persian(self, text: str) -> str:
        """ÙØ±Ù…Øª Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ PDF"""
        
        if not text:
            return ''
            
        # Reshape Arabic/Persian text
        reshaped_text = arabic_reshaper.reshape(text)
        
        # Apply RTL algorithm
        bidi_text = get_display(reshaped_text)
        
        return bidi_text
        
    async def _create_prescription(self, report: GeneratedReport) -> List:
        """Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø®Ø´ Ù†Ø³Ø®Ù‡"""
        
        story = []
        
        # Ø¹Ù†ÙˆØ§Ù†
        story.append(Paragraph(
            self._format_persian("Ù†Ø³Ø®Ù‡ Ù¾Ø²Ø´Ú©ÛŒ"),
            self.styles['PersianTitle']
        ))
        
        story.append(Spacer(1, 0.5*cm))
        
        # Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø±ÙˆÙ‡Ø§
        medications = report.content['plan']['medications']
        
        # Header Ø¬Ø¯ÙˆÙ„
        table_data = [[
            self._format_persian("Ø±Ø¯ÛŒÙ"),
            self._format_persian("Ù†Ø§Ù… Ø¯Ø§Ø±Ùˆ"),
            self._format_persian("Ø¯ÙˆØ²"),
            self._format_persian("Ø±ÙˆØ´ Ù…ØµØ±Ù"),
            self._format_persian("ØªØ¹Ø¯Ø§Ø¯/Ù…Ø¯Øª")
        ]]
        
        # Ø¯Ø§Ø±ÙˆÙ‡Ø§
        for i, med in enumerate(medications, 1):
            table_data.append([
                self._format_persian(str(i)),
                self._format_persian(med['name']),
                self._format_persian(med['dosage']),
                self._format_persian(med['route']),
                self._format_persian(f"{med['frequency']} - {med['duration']}")
            ])
            
        # Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„
        med_table = Table(table_data, colWidths=[1.5*cm, 6*cm, 3*cm, 3*cm, 4*cm])
        med_table.setStyle(TableStyle([
            # Header style
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#0066cc')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('FONTNAME', (0, 0), (-1, 0), 'Vazir-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('ALIGN', (0, 0), (-1, 0), 'CENTER'),
            
            # Body style
            ('FONTNAME', (0, 1), (-1, -1), 'Vazir'),
            ('FONTSIZE', (0, 1), (-1, -1), 10),
            ('ALIGN', (0, 1), (-1, -1), 'RIGHT'),
            ('GRID', (0, 0), (-1, -1), 0.5, colors.grey),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.HexColor('#f5f5f5')]),
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ]))
        
        story.append(med_table)
        
        return story
```

### Advanced PDF Features

```python
# outputs/services/pdf_advanced.py

class AdvancedPDFGenerator(PDFGenerator):
    """ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ PDF Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ"""
    
    async def add_watermark(
        self,
        pdf_path: str,
        watermark_text: str = "HELSSA"
    ) -> str:
        """Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§ØªØ±Ù…Ø§Ø±Ú©"""
        
        # Ø®ÙˆØ§Ù†Ø¯Ù† PDF
        reader = PdfReader(pdf_path)
        writer = PdfWriter()
        
        # Ø§ÛŒØ¬Ø§Ø¯ ÙˆØ§ØªØ±Ù…Ø§Ø±Ú©
        watermark = await self._create_watermark(watermark_text)
        
        # Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù‡Ù…Ù‡ ØµÙØ­Ø§Øª
        for page in reader.pages:
            page.merge_page(watermark)
            writer.add_page(page)
            
        # Ø°Ø®ÛŒØ±Ù‡
        output_path = pdf_path.replace('.pdf', '_watermarked.pdf')
        with open(output_path, 'wb') as output_file:
            writer.write(output_file)
            
        return output_path
        
    async def add_digital_signature(
        self,
        pdf_path: str,
        doctor_id: str,
        signature_image_path: Optional[str] = None
    ) -> str:
        """Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„"""
        
        # Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ù…Ø¶Ø§
        doctor = await Doctor.objects.get(id=doctor_id)
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„
        signature = await self._create_digital_signature(doctor)
        
        # Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ PDF
        signed_pdf = await self._apply_signature(
            pdf_path,
            signature,
            signature_image_path
        )
        
        return signed_pdf
        
    async def add_qr_code(
        self,
        pdf_path: str,
        verification_url: str
    ) -> str:
        """Ø§ÙØ²ÙˆØ¯Ù† QR Code Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø§ØµØ§Ù„Øª"""
        
        import qrcode
        
        # ØªÙˆÙ„ÛŒØ¯ QR Code
        qr = qrcode.QRCode(
            version=1,
            error_correction=qrcode.constants.ERROR_CORRECT_H,
            box_size=10,
            border=4,
        )
        
        qr.add_data(verification_url)
        qr.make(fit=True)
        
        qr_image = qr.make_image(fill_color="black", back_color="white")
        
        # Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ PDF
        # ... Ú©Ø¯ Ø§ÙØ²ÙˆØ¯Ù† QR Ø¨Ù‡ PDF
        
        return pdf_path
```

## ğŸ’Š ØªÙˆÙ„ÛŒØ¯ Ù†Ø³Ø®Ù‡ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©

### Prescription Generator

```python
# outputs/services/prescription_generator.py

class PrescriptionGenerator:
    """ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ù†Ø³Ø®Ù‡ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©"""
    
    def __init__(self):
        self.drug_database = DrugDatabase()
        self.interaction_checker = DrugInteractionChecker()
        self.insurance_validator = InsuranceValidator()
        
    async def generate_prescription(
        self,
        encounter_id: str,
        medications: List[Dict],
        doctor_id: str
    ) -> Prescription:
        """ØªÙˆÙ„ÛŒØ¯ Ù†Ø³Ø®Ù‡ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©"""
        
        # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¯Ø§Ø±ÙˆÙ‡Ø§
        validated_meds = []
        for med in medications:
            # Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø§Ø±ÙˆÛŒÛŒ
            drug_info = await self.drug_database.lookup(med['name'])
            if not drug_info:
                raise DrugNotFoundError(f"Ø¯Ø§Ø±Ùˆ ÛŒØ§ÙØª Ù†Ø´Ø¯: {med['name']}")
                
            # Ø¨Ø±Ø±Ø³ÛŒ Ø¯ÙˆØ²
            if not await self._validate_dosage(drug_info, med['dosage']):
                raise InvalidDosageError(
                    f"Ø¯ÙˆØ² Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø±Ø§ÛŒ {med['name']}: {med['dosage']}"
                )
                
            validated_meds.append({
                **med,
                'drug_code': drug_info['code'],
                'generic_name': drug_info['generic_name'],
                'brand_name': drug_info['brand_name']
            })
            
        # Ø¨Ø±Ø±Ø³ÛŒ ØªØ¯Ø§Ø®Ù„Ø§Øª Ø¯Ø§Ø±ÙˆÛŒÛŒ
        interactions = await self.interaction_checker.check_interactions(
            validated_meds
        )
        
        if interactions['severe']:
            raise SevereInteractionError(
                f"ØªØ¯Ø§Ø®Ù„ Ø´Ø¯ÛŒØ¯: {interactions['severe']}"
            )
            
        # Ø¨Ø±Ø±Ø³ÛŒ Ø¨ÛŒÙ…Ù‡
        insurance_coverage = await self.insurance_validator.check_coverage(
            encounter_id,
            validated_meds
        )
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø³Ø®Ù‡
        prescription = await Prescription.objects.create(
            encounter_id=encounter_id,
            doctor_id=doctor_id,
            medications=validated_meds,
            interactions=interactions,
            insurance_coverage=insurance_coverage,
            status='draft',
            metadata={
                'created_by': 'system',
                'version': '2.0'
            }
        )
        
        # ØªÙˆÙ„ÛŒØ¯ Ø¨Ø§Ø±Ú©Ø¯
        prescription.barcode = await self._generate_prescription_barcode(
            prescription
        )
        await prescription.save()
        
        return prescription
        
    async def _generate_prescription_barcode(
        self,
        prescription: Prescription
    ) -> str:
        """ØªÙˆÙ„ÛŒØ¯ Ø¨Ø§Ø±Ú©Ø¯ Ù†Ø³Ø®Ù‡"""
        
        from barcode import Code128
        from barcode.writer import ImageWriter
        
        # ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ ÛŒÚ©ØªØ§
        code = f"RX{prescription.id.hex[:8].upper()}"
        
        # ØªÙˆÙ„ÛŒØ¯ Ø¨Ø§Ø±Ú©Ø¯
        barcode = Code128(code, writer=ImageWriter())
        
        # Ø°Ø®ÛŒØ±Ù‡
        buffer = io.BytesIO()
        barcode.write(buffer)
        
        # Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ù‡ storage
        path = f"prescriptions/{prescription.id}/barcode.png"
        url = await upload_to_storage(path, buffer.getvalue())
        
        return url
```

### E-Prescription Format

```python
# outputs/models/prescription.py

class Prescription(models.Model):
    """Ù…Ø¯Ù„ Ù†Ø³Ø®Ù‡ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©"""
    
    PRESCRIPTION_STATUS = [
        ('draft', 'Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³'),
        ('signed', 'Ø§Ù…Ø¶Ø§ Ø´Ø¯Ù‡'),
        ('submitted', 'Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡'),
        ('dispensed', 'ØªØ­ÙˆÛŒÙ„ Ø´Ø¯Ù‡'),
        ('cancelled', 'Ù„ØºÙˆ Ø´Ø¯Ù‡'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4)
    encounter = models.OneToOneField(
        'encounters.Encounter',
        on_delete=models.CASCADE,
        related_name='prescription'
    )
    doctor = models.ForeignKey(
        'unified_auth.UnifiedUser',
        on_delete=models.PROTECT,
        related_name='prescriptions_written'
    )
    
    # Ø¯Ø§Ø±ÙˆÙ‡Ø§
    medications = models.JSONField(
        help_text="Ù„ÛŒØ³Øª Ø¯Ø§Ø±ÙˆÙ‡Ø§ÛŒ ØªØ¬ÙˆÛŒØ² Ø´Ø¯Ù‡"
    )
    """
    [
        {
            "name": "Ù†Ø§Ù… Ø¯Ø§Ø±Ùˆ",
            "generic_name": "Ù†Ø§Ù… Ú˜Ù†Ø±ÛŒÚ©",
            "drug_code": "Ú©Ø¯ Ø¯Ø§Ø±Ùˆ",
            "dosage": "Ø¯ÙˆØ²",
            "route": "Ø±ÙˆØ´ Ù…ØµØ±Ù",
            "frequency": "Ø¯ÙØ¹Ø§Øª Ù…ØµØ±Ù",
            "duration": "Ù…Ø¯Øª Ù…ØµØ±Ù",
            "quantity": "ØªØ¹Ø¯Ø§Ø¯",
            "instructions": "Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„",
            "insurance_covered": true
        }
    ]
    """
    
    # ØªØ¯Ø§Ø®Ù„Ø§Øª
    drug_interactions = models.JSONField(
        default=dict,
        help_text="ØªØ¯Ø§Ø®Ù„Ø§Øª Ø¯Ø§Ø±ÙˆÛŒÛŒ"
    )
    
    # Ø¨ÛŒÙ…Ù‡
    insurance_coverage = models.JSONField(
        default=dict,
        help_text="Ù¾ÙˆØ´Ø´ Ø¨ÛŒÙ…Ù‡"
    )
    total_cost = models.DecimalField(
        max_digits=10,
        decimal_places=0,
        null=True,
        blank=True
    )
    insurance_share = models.DecimalField(
        max_digits=10,
        decimal_places=0,
        null=True,
        blank=True
    )
    patient_share = models.DecimalField(
        max_digits=10,
        decimal_places=0,
        null=True,
        blank=True
    )
    
    # Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§
    prescription_code = models.CharField(
        max_length=20,
        unique=True,
        help_text="Ú©Ø¯ ÛŒÚ©ØªØ§ÛŒ Ù†Ø³Ø®Ù‡"
    )
    barcode = models.URLField(
        null=True,
        blank=True,
        help_text="Ø¢Ø¯Ø±Ø³ ØªØµÙˆÛŒØ± Ø¨Ø§Ø±Ú©Ø¯"
    )
    
    # ÙˆØ¶Ø¹ÛŒØª
    status = models.CharField(
        max_length=20,
        choices=PRESCRIPTION_STATUS,
        default='draft'
    )
    
    # Ø§Ù…Ø¶Ø§
    is_signed = models.BooleanField(default=False)
    signed_at = models.DateTimeField(null=True, blank=True)
    signature_data = models.JSONField(
        null=True,
        blank=True,
        help_text="Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„"
    )
    
    # ØªØ­ÙˆÛŒÙ„
    pharmacy = models.ForeignKey(
        'pharmacies.Pharmacy',
        on_delete=models.SET_NULL,
        null=True,
        blank=True
    )
    dispensed_at = models.DateTimeField(null=True, blank=True)
    dispensed_by = models.CharField(
        max_length=100,
        null=True,
        blank=True
    )
    
    # Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    expires_at = models.DateTimeField(
        help_text="ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ù†Ø³Ø®Ù‡"
    )
    
    class Meta:
        db_table = 'prescriptions'
        indexes = [
            models.Index(fields=['prescription_code']),
            models.Index(fields=['doctor', 'status']),
            models.Index(fields=['created_at']),
        ]
```

## âœï¸ Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„

### Digital Signature Service

```python
# outputs/services/signature_service.py
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.asymmetric import rsa, padding
from cryptography.hazmat.primitives import serialization
import base64

class DigitalSignatureService:
    """Ø³Ø±ÙˆÛŒØ³ Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„"""
    
    def __init__(self):
        self.key_manager = KeyManager()
        
    async def sign_document(
        self,
        document_id: str,
        doctor_id: str,
        document_hash: str
    ) -> Dict:
        """Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ø³Ù†Ø¯"""
        
        # Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ú©Ù„ÛŒØ¯ Ø®ØµÙˆØµÛŒ Ù¾Ø²Ø´Ú©
        private_key = await self.key_manager.get_doctor_private_key(
            doctor_id
        )
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ø§Ù…Ø¶Ø§
        signature = private_key.sign(
            document_hash.encode(),
            padding.PSS(
                mgf=padding.MGF1(hashes.SHA256()),
                salt_length=padding.PSS.MAX_LENGTH
            ),
            hashes.SHA256()
        )
        
        # Ø§ÛŒØ¬Ø§Ø¯ timestamp
        timestamp = await self._create_timestamp()
        
        # Ø³Ø§Ø®Øª signature object
        signature_data = {
            'signature': base64.b64encode(signature).decode(),
            'algorithm': 'RSA-PSS-SHA256',
            'doctor_id': doctor_id,
            'document_id': document_id,
            'document_hash': document_hash,
            'timestamp': timestamp,
            'certificate': await self._get_doctor_certificate(doctor_id)
        }
        
        # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± blockchain (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        if settings.BLOCKCHAIN_ENABLED:
            blockchain_hash = await self._store_in_blockchain(
                signature_data
            )
            signature_data['blockchain_hash'] = blockchain_hash
            
        return signature_data
        
    async def verify_signature(
        self,
        signature_data: Dict,
        document_hash: str
    ) -> bool:
        """ØªØ§ÛŒÛŒØ¯ Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„"""
        
        # Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ú©Ù„ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ
        public_key = await self.key_manager.get_doctor_public_key(
            signature_data['doctor_id']
        )
        
        # ØªØ§ÛŒÛŒØ¯ Ø§Ù…Ø¶Ø§
        try:
            public_key.verify(
                base64.b64decode(signature_data['signature']),
                document_hash.encode(),
                padding.PSS(
                    mgf=padding.MGF1(hashes.SHA256()),
                    salt_length=padding.PSS.MAX_LENGTH
                ),
                hashes.SHA256()
            )
            
            # ØªØ§ÛŒÛŒØ¯ timestamp
            if not await self._verify_timestamp(signature_data['timestamp']):
                return False
                
            # ØªØ§ÛŒÛŒØ¯ certificate
            if not await self._verify_certificate(
                signature_data['certificate']
            ):
                return False
                
            return True
            
        except Exception:
            return False
            
    async def _create_timestamp(self) -> Dict:
        """Ø§ÛŒØ¬Ø§Ø¯ timestamp Ø§Ù…Ù†"""
        
        # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² timestamp server
        if settings.TIMESTAMP_SERVER:
            return await self._get_trusted_timestamp()
            
        # timestamp Ù…Ø­Ù„ÛŒ
        return {
            'time': datetime.utcnow().isoformat(),
            'timezone': 'UTC',
            'source': 'local'
        }
```

## ğŸ¨ Ø³ÙØ§Ø±Ø´ÛŒâ€ŒØ³Ø§Ø²ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§

### Report Customization Service

```python
# outputs/services/customization_service.py

class ReportCustomizationService:
    """Ø³Ø±ÙˆÛŒØ³ Ø³ÙØ§Ø±Ø´ÛŒâ€ŒØ³Ø§Ø²ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§"""
    
    def __init__(self):
        self.template_manager = TemplateManager()
        self.style_manager = StyleManager()
        
    async def customize_report(
        self,
        report_id: str,
        customization_options: Dict
    ) -> GeneratedReport:
        """Ø³ÙØ§Ø±Ø´ÛŒâ€ŒØ³Ø§Ø²ÛŒ Ú¯Ø²Ø§Ø±Ø´"""
        
        report = await GeneratedReport.objects.get(id=report_id)
        
        # Ø§Ø¹Ù…Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø±Ù†Ø¯
        if customization_options.get('branding'):
            report = await self._apply_branding(
                report,
                customization_options['branding']
            )
            
        # ØªØºÛŒÛŒØ± Ù‚Ø§Ù„Ø¨
        if customization_options.get('template'):
            report = await self._change_template(
                report,
                customization_options['template']
            )
            
        # Ø³ÙØ§Ø±Ø´ÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø§Ø³ØªØ§ÛŒÙ„
        if customization_options.get('styles'):
            report = await self._customize_styles(
                report,
                customization_options['styles']
            )
            
        # Ø§ÙØ²ÙˆØ¯Ù†/Ø­Ø°Ù Ø¨Ø®Ø´â€ŒÙ‡Ø§
        if customization_options.get('sections'):
            report = await self._modify_sections(
                report,
                customization_options['sections']
            )
            
        # ØªÙˆÙ„ÛŒØ¯ Ù…Ø¬Ø¯Ø¯ Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§
        await self._regenerate_outputs(report)
        
        return report
        
    async def _apply_branding(
        self,
        report: GeneratedReport,
        branding: Dict
    ) -> GeneratedReport:
        """Ø§Ø¹Ù…Ø§Ù„ Ø¨Ø±Ù†Ø¯ÛŒÙ†Ú¯"""
        
        # Ù„ÙˆÚ¯Ùˆ
        if branding.get('logo'):
            report.metadata['branding']['logo_url'] = branding['logo']
            
        # Ø±Ù†Ú¯â€ŒÙ‡Ø§
        if branding.get('colors'):
            report.metadata['branding']['primary_color'] = branding['colors']['primary']
            report.metadata['branding']['secondary_color'] = branding['colors']['secondary']
            
        # ÙÙˆÙ†Øª
        if branding.get('font'):
            report.metadata['branding']['font_family'] = branding['font']
            
        # Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø§Ø³
        if branding.get('contact'):
            report.metadata['branding']['contact'] = branding['contact']
            
        await report.save()
        return report
```

### Custom Report Templates

```python
# outputs/services/template_manager.py

class TemplateManager:
    """Ù…Ø¯ÛŒØ±ÛŒØª Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´"""
    
    async def create_custom_template(
        self,
        name: str,
        template_type: str,
        content: str,
        clinic_id: Optional[str] = None
    ) -> ReportTemplate:
        """Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø§Ù„Ø¨ Ø³ÙØ§Ø±Ø´ÛŒ"""
        
        # Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù‚Ø§Ù„Ø¨
        validation = await self._validate_template(content)
        if not validation['valid']:
            raise InvalidTemplateError(validation['errors'])
            
        # Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø§Ù„Ø¨
        template = await ReportTemplate.objects.create(
            name=name,
            type=template_type,
            content=content,
            clinic_id=clinic_id,
            is_active=True,
            variables=self._extract_variables(content),
            metadata={
                'created_by': 'user',
                'version': '1.0'
            }
        )
        
        # Ú©Ø§Ù…Ù¾Ø§ÛŒÙ„ Ù‚Ø§Ù„Ø¨
        await self._compile_template(template)
        
        return template
        
    def _extract_variables(self, content: str) -> List[str]:
        """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù‚Ø§Ù„Ø¨"""
        
        import re
        
        # ÛŒØ§ÙØª Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Jinja2
        pattern = r'\{\{\s*(\w+(?:\.\w+)*)\s*\}\}'
        variables = re.findall(pattern, content)
        
        # Ø­Ø°Ù ØªÚ©Ø±Ø§Ø±ÛŒâ€ŒÙ‡Ø§
        return list(set(variables))
```

---

[ELEMENT: div align="center"]

[â†’ Ù‚Ø¨Ù„ÛŒ: Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙˆØª Ùˆ STT](11-audio-processing.md) | [Ø¨Ø¹Ø¯ÛŒ: Ø²ÛŒØ±Ø³Ø§Ø®Øª Ùˆ Docker â†](13-infrastructure.md)

</div>
